<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Secure System</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Dashboard-specific styles using the modern design system */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            font-family: var(--font-family);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-overlay);
            z-index: -1;
        }

        .dashboard-wrapper {
            min-height: 100vh;
            padding: var(--space-4);
        }

        /* Header */
        .dashboard-header {
            background: var(--bg-primary);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            padding: var(--space-8);
            margin-bottom: var(--space-8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-4);
            border: 1px solid var(--gray-200);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .dashboard-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            color: var(--gray-900);
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .dashboard-title i {
            color: var(--primary-color);
            font-size: 1.75rem;
        }

        .user-welcome {
            color: var(--gray-600);
            font-size: 1rem;
            margin: var(--space-1) 0 0 0;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .session-timer {
            background: linear-gradient(135deg, var(--accent-warning), #d97706);
            color: white;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .notification-btn {
            position: relative;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-md);
        }

        .notification-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--accent-danger);
            color: white;
            border-radius: var(--radius-full);
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .logout-btn {
            background: var(--accent-danger);
            color: white;
            border: none;
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            box-shadow: var(--shadow-md);
        }

        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* Main Grid Layout */
        .dashboard-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: var(--space-8);
            margin-bottom: var(--space-8);
        }

        /* Cards */
        .dashboard-card {
            background: var(--bg-primary);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            padding: var(--space-8);
            border: 1px solid var(--gray-200);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            z-index: 1;
        }

        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-2xl);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--gray-200);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .card-icon.user { background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); }
        .card-icon.security { background: linear-gradient(135deg, var(--accent-color), #059669); }
        .card-icon.activity { background: linear-gradient(135deg, var(--accent-warning), #d97706); }
        .card-icon.settings { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .card-icon.analytics { background: linear-gradient(135deg, var(--accent-info), #0891b2); }

        .card-title {
            color: var(--gray-900);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        /* Info Items */
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4) 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: var(--gray-700);
            font-size: 1rem;
        }

        .info-value {
            color: var(--gray-600);
            font-weight: 500;
            font-size: 1rem;
        }

        /* Status Badges */
        .status-badge {
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-verified {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-color);
        }

        .status-unverified {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-danger);
        }

        .status-active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-color);
        }

        .status-inactive {
            background: rgba(107, 114, 128, 0.1);
            color: var(--gray-500);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--space-4);
            margin: var(--space-6) 0;
        }

        .stat-item {
            text-align: center;
            padding: var(--space-6);
            background: var(--gray-50);
            border-radius: var(--radius-xl);
            border: 1px solid var(--gray-200);
            transition: all var(--transition-fast);
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: var(--space-2);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray-600);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: var(--space-3);
            margin-top: var(--space-6);
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            min-width: 140px;
            padding: var(--space-4) var(--space-6);
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            text-decoration: none;
            box-shadow: var(--shadow-md);
        }

        .action-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .action-btn.primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .action-btn.secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-200);
        }

        .action-btn.secondary:hover {
            background: var(--gray-200);
            border-color: var(--gray-300);
        }

        .action-btn.success {
            background: var(--accent-color);
            color: white;
        }

        .action-btn.success:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .action-btn.warning {
            background: var(--accent-warning);
            color: white;
        }

        .action-btn.warning:hover {
            background: #d97706;
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: var(--space-6) 0;
        }

        /* Activity Log */
        .activity-log {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-3);
            transition: all var(--transition-fast);
        }

        .activity-item:hover {
            background: var(--gray-50);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            flex-shrink: 0;
        }

        .activity-icon.login { background: var(--accent-color); }
        .activity-icon.logout { background: var(--accent-danger); }
        .activity-icon.update { background: var(--accent-warning); }
        .activity-icon.security { background: var(--primary-color); }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: var(--gray-900);
            font-size: 0.95rem;
            margin-bottom: var(--space-1);
        }

        .activity-time {
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        /* Loading States */
        #loadingSpinner {
            display: none;
            text-align: center;
            padding: var(--space-20);
            background: var(--bg-primary);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--gray-200);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid var(--gray-200);
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-6);
        }

        .loading-text {
            color: var(--gray-600);
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Error Message */
        #errorMessage {
            display: none;
            background: var(--bg-primary);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-left: 4px solid var(--accent-danger);
            color: var(--accent-danger);
            padding: var(--space-8);
            border-radius: var(--radius-2xl);
            margin: var(--space-8) 0;
            text-align: center;
            box-shadow: var(--shadow-xl);
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* Notification Dropdown */
        .notification-dropdown {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-2xl);
            width: 400px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            border: 1px solid var(--gray-200);
            animation: slideDown 0.3s ease-out;
        }

        .notification-dropdown.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--gray-200);
            font-weight: 700;
            color: var(--gray-900);
            text-align: center;
        }

        .notification-item {
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--gray-100);
            transition: background var(--transition-fast);
            cursor: pointer;
        }

        .notification-item:hover {
            background: var(--gray-50);
        }

        .notification-item.unread {
            background: rgba(37, 99, 235, 0.05);
            border-left: 4px solid var(--primary-color);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-wrapper {
                padding: var(--space-3);
            }
            
            .dashboard-header {
                flex-direction: column;
            text-align: center;
                padding: var(--space-6);
            }
            
            .header-actions {
                width: 100%;
                justify-content: center;
            }
            
        .dashboard-card {
                padding: var(--space-6);
            }
            
        .action-buttons {
                flex-direction: column;
        }

        .action-btn {
            width: 100%;
            }
            
        .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .dashboard-title {
                font-size: 1.5rem;
                flex-direction: column; 
                gap: var(--space-2);
            }
            
            .stats-grid {
                grid-template-columns: 1fr; 
            }
            
            .header-actions {
            flex-direction: column;
                gap: var(--space-3);
            }
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-wrapper">
        <!-- Loading Spinner -->
        <div id="loadingSpinner">
            <div class="spinner"></div>
            <div class="loading-text">Loading your dashboard...</div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage"></div>

        <!-- Dashboard Header -->
        <header id="dashboardHeader" class="dashboard-header" style="display: none;">
            <div class="header-left">
            <div>
                <h1 class="dashboard-title">
                        <i class="fas fa-shield-halved" aria-hidden="true"></i>
                        Secure Dashboard
                </h1>
                    <p id="userWelcome" class="user-welcome">Welcome back, User!</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="session-timer">
                    <i class="fas fa-clock" aria-hidden="true"></i>
                    <span id="sessionTimer">29:45</span>
                </div>
                <button class="notification-btn" id="notificationBtn" aria-label="Notifications">
                    <i class="fas fa-bell" aria-hidden="true"></i>
                    <span class="notification-badge" id="notificationBadge">3</span>
                    </button>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                    Logout
                </button>
            </div>
        </header>

        <!-- Main Dashboard Content -->
        <main id="dashboardContent" class="dashboard-content" style="display: none;">
            <!-- User Profile Card -->
            <section class="dashboard-card fade-in">
                <div class="card-header">
                    <div class="card-icon user">
                        <i class="fas fa-user" aria-hidden="true"></i>
                    </div>
                    <h2 class="card-title">Profile Information</h2>
                </div>
                <div id="userProfileContent">
                    <div class="info-item">
                        <span class="info-label">Username</span>
                        <span class="info-value">Loading...</span>
                </div>
                    <div class="info-item">
                        <span class="info-label">Email</span>
                        <span class="info-value">Loading...</span>
            </div>
                    <div class="info-item">
                        <span class="info-label">Account Status</span>
                        <span id="accountStatus" class="status-badge status-verified">Verified</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Member Since</span>
                        <span id="accountCreated" class="info-value">Loading...</span>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="action-btn secondary" id="editProfileBtn">
                        <i class="fas fa-edit" aria-hidden="true"></i>
                        Edit Profile
                    </button>
                </div>
            </section>

            <!-- Current Session Info -->
            <section class="dashboard-card fade-in">
                <div class="card-header">
                    <div class="card-icon security">
                        <i class="fas fa-desktop" aria-hidden="true"></i>
                    </div>
                    <h2 class="card-title">Current Session</h2>
                </div>
                    <div class="info-item">
                    <span class="info-label">Device Type</span>
                    <span class="info-value" id="currentDeviceType">Desktop Computer</span>
                    </div>
                    <div class="info-item">
                    <span class="info-label">Browser</span>
                    <span class="info-value" id="currentBrowser">Loading...</span>
                    </div>
                    <div class="info-item">
                    <span class="info-label">Operating System</span>
                    <span class="info-value" id="currentOS">Loading...</span>
                    </div>
                    <div class="info-item">
                    <span class="info-label">IP Address</span>
                    <span class="info-value" id="currentIP">Loading...</span>
                    </div>
                    <div class="info-item">
                    <span class="info-label">Location</span>
                    <span class="info-value" id="currentLocation">Loading...</span>
                    </div>
                <div class="info-item">
                    <span class="info-label">Session Started</span>
                    <span class="info-value" id="sessionStartTime">Loading...</span>
                </div>
                        <div class="action-buttons">
                    <button class="action-btn warning" id="viewAllSessionsBtn">
                        <i class="fas fa-list" aria-hidden="true"></i>
                        View All Sessions
                            </button>
                    <button class="action-btn secondary" id="endOtherSessionsBtn">
                        <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                        End Other Sessions
                            </button>
                        </div>
            </section>

            <!-- Security Overview -->
            <section class="dashboard-card fade-in">
                <div class="card-header">
                    <div class="card-icon security">
                        <i class="fas fa-shield-alt" aria-hidden="true"></i>
                    </div>
                    <h2 class="card-title">Security Overview</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">5</div>
                        <div class="stat-label">Login Attempts</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">2</div>
                        <div class="stat-label">Failed Attempts</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">24h</div>
                        <div class="stat-label">Last Login</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">98%</div>
                        <div class="stat-label">Security Score</div>
                    </div>
                </div>
                <div class="info-item">
                    <span class="info-label">Two-Factor Authentication</span>
                    <span class="status-badge status-active">Enabled</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Email Verification</span>
                    <span class="status-badge status-active">Verified</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Password Expires On</span>
                    <span class="info-value" id="passwordExpiryDate">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Days Until Expiry</span>
                    <span class="info-value" id="passwordDaysLeft">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Last Security Check</span>
                    <span class="info-value" id="lastLoginTime">Loading...</span>
                </div>
                <div class="action-buttons">
                    <button class="action-btn warning" id="viewSecurityLogsBtn">
                        <i class="fas fa-history" aria-hidden="true"></i>
                        Security Logs
                    </button>
                    <button class="action-btn primary" id="changePasswordBtn">
                        <i class="fas fa-key" aria-hidden="true"></i>
                        Change Password Now
                    </button>
                </div>
            </section>

            <!-- Analytics Chart -->
            <section class="dashboard-card fade-in">
                <div class="card-header">
                    <div class="card-icon analytics">
                        <i class="fas fa-chart-line" aria-hidden="true"></i>
                    </div>
                    <h2 class="card-title">Login Analytics</h2>
                </div>
                <div class="chart-container">
                    <canvas id="loginChart"></canvas>
                </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                        <div class="stat-number">156</div>
                        <div class="stat-label">Total Logins</div>
                        </div>
                        <div class="stat-item">
                        <div class="stat-number">12</div>
                        <div class="stat-label">This Week</div>
                        </div>
                    <div class="stat-item">
                        <div class="stat-number">3.2</div>
                        <div class="stat-label">Avg/Day</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">99.2%</div>
                        <div class="stat-label">Success Rate</div>
                </div>
            </div>
            </section>

            <!-- Recent Activity -->
            <section class="dashboard-card fade-in">
                <div class="card-header">
                    <div class="card-icon activity">
                        <i class="fas fa-clock" aria-hidden="true"></i>
                    </div>
                    <h2 class="card-title">Recent Activity</h2>
                </div>
                <div class="activity-log" id="recentActivityContainer">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Loading recent activity...</div>
                            <div class="activity-time">Please wait</div>
                        </div>
                    </div>
                </div>
                    <div class="action-buttons">
                    <button class="action-btn secondary" id="viewAllActivityBtn">
                        <i class="fas fa-list" aria-hidden="true"></i>
                        View All Activity
                        </button>
                    <button class="action-btn secondary" id="downloadLogsBtn">
                        <i class="fas fa-download" aria-hidden="true"></i>
                        Download Logs
                        </button>
                    </div>
            </section>

            <!-- Quick Actions -->
            <section class="dashboard-card fade-in">
                <div class="card-header">
                    <div class="card-icon settings">
                        <i class="fas fa-cogs" aria-hidden="true"></i>
                    </div>
                    <h2 class="card-title">Quick Actions</h2>
                </div>
                    <!-- Removed duplicate Change Password button -->
                <div class="action-buttons">
                    <button class="action-btn secondary" id="exportDataBtn">
                        <i class="fas fa-file-export" aria-hidden="true"></i>
                        Export Data
                        </button>
                    <button class="action-btn secondary" id="contactSupportBtn">
                        <i class="fas fa-support" aria-hidden="true"></i>
                        Support
                        </button>
                    </div>
                <div class="info-item" style="margin-top: 1.5rem;">
                    <span class="info-label">Account Created</span>
                    <span class="info-value" id="memberSince">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Data Usage</span>
                    <span class="info-value">2.3 MB</span>
            </div>
                <div class="info-item">
                    <span class="info-label">Storage Used</span>
                    <span class="info-value">156 KB</span>
        </div>
            </section>
        </main>

        <!-- Notification Dropdown -->
        <div id="notificationDropdown" class="notification-dropdown">
            <div class="notification-header">
                <h3>Notifications</h3>
            </div>
            <div class="notification-item unread">
                <div style="font-weight: 600; margin-bottom: 4px;">Security Alert</div>
                <div style="font-size: 0.9rem; color: #666;">New login detected from Chrome on Windows</div>
                <div style="font-size: 0.8rem; color: #999; margin-top: 4px;">2 hours ago</div>
            </div>
                        <div class="notification-item unread">
                <div style="font-weight: 600; margin-bottom: 4px;">Password Expiry Warning</div>
                <div style="font-size: 0.9rem; color: #666;">Your password will expire in 15 days (30-day policy)</div>
                <div style="font-size: 0.8rem; color: #999; margin-top: 4px;">1 day ago</div>
            </div>
            <div class="notification-item">
                <div style="font-weight: 600; margin-bottom: 4px;">Account Updated</div>
                <div style="font-size: 0.9rem; color: #666;">Profile information successfully updated</div>
                <div style="font-size: 0.8rem; color: #999; margin-top: 4px;">3 days ago</div>
    </div>
                    </div>
                    </div>

    <!-- Scripts -->
    <script src="js/utils.js?v=1.0.4"></script>
    <script src="js/session-manager.js?v=1.0.4"></script>
    <script src="js/dashboard.js?v=1.0.4"></script>
    
    <script>
        // Enhanced dashboard functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Chart.js for analytics
            const ctx = document.getElementById('loginChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Daily Logins',
                            data: [12, 19, 3, 5, 2, 3, 10],
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#f1f5f9'
                                }
                            },
                            x: {
                                grid: {
                                    color: '#f1f5f9'
                                }
                            }
                        }
                    }
                });
            }

            // Notification dropdown toggle
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.getElementById('notificationDropdown');
            
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    notificationDropdown.classList.toggle('show');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!notificationDropdown.contains(e.target)) {
                        notificationDropdown.classList.remove('show');
                    }
                });
            }

                        // Session timer functionality (Updated to 3 minutes with comprehensive cleanup)
            let sessionTime = 3 * 60; // 3 minutes in seconds (updated from 30 minutes)
            let sessionWarningShown = false;
            let lastWarningTime = 0;
            const sessionTimer = document.getElementById('sessionTimer');
            
            function updateSessionTimer() {
                const minutes = Math.floor(sessionTime / 60);
                const seconds = sessionTime % 60;
                if (sessionTimer) {
                    sessionTimer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Progressive visual warnings
                    if (sessionTime <= 30) { // Last 30 seconds - critical warning
                        sessionTimer.style.background = 'linear-gradient(135deg, #dc2626, #991b1b)';
                        sessionTimer.style.animation = 'pulse 0.5s infinite';
                        sessionTimer.style.boxShadow = '0 0 20px rgba(220, 38, 38, 0.5)';
                    } else if (sessionTime <= 60) { // Last minute warning
                        sessionTimer.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                        sessionTimer.style.animation = 'pulse 1s infinite';
                        sessionTimer.style.boxShadow = '0 0 15px rgba(239, 68, 68, 0.3)';
                    } else if (sessionTime <= 120) { // Last 2 minutes warning
                        sessionTimer.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                        sessionTimer.style.boxShadow = '0 0 10px rgba(245, 158, 11, 0.2)';
                    }
                    
                    // Show warning dialogs at specific intervals
                    if (sessionTime === 60 && !sessionWarningShown) {
                        showSessionWarning(60);
                        sessionWarningShown = true;
                        lastWarningTime = 60;
                    } else if (sessionTime === 30 && lastWarningTime !== 30) {
                        showSessionWarning(30);
                        lastWarningTime = 30;
                    } else if (sessionTime === 10 && lastWarningTime !== 10) {
                        showSessionWarning(10);
                        lastWarningTime = 10;
                    }
                }
                
                if (sessionTime <= 0) {
                    handleSessionExpiry();
                    return;
                }
                
                sessionTime--;
            }
            
            // Show session warning with option to extend
            function showSessionWarning(timeLeft) {
                const timeText = timeLeft === 60 ? '1 minute' : `${timeLeft} seconds`;
                
                Swal.fire({
                    title: '‚è∞ Session Expiring Soon',
                    html: `
                        <div style="text-align: center;">
                            <div style="font-size: 48px; color: #f59e0b; margin-bottom: 15px;">
                                <i class="fas fa-clock"></i>
                            </div>
                            <p style="font-size: 16px; margin-bottom: 15px; color: #374151;">
                                Your session will expire in <strong style="color: #dc2626;">${timeText}</strong>
                            </p>
                            <p style="color: #6b7280; margin-bottom: 20px;">
                                Click "Stay Logged In" to extend your session, or "Logout" to end it now.
                            </p>
                            <div style="background: #fef3c7; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                <small style="color: #92400e;">
                                    üí° <strong>Security Tip:</strong> Sessions automatically expire for your protection.
                                </small>
                            </div>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Stay Logged In',
                    cancelButtonText: 'Logout Now',
                    allowOutsideClick: false,
                    confirmButtonColor: '#10b981',
                    cancelButtonColor: '#ef4444',
                    timer: timeLeft * 1000,
                    timerProgressBar: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        extendSession();
                    } else if (result.dismiss === Swal.DismissReason.cancel) {
                        handleManualLogout();
                    } else if (result.dismiss === Swal.DismissReason.timer) {
                        handleSessionExpiry();
                    }
                });
            }
            
            // Extend session when user chooses to stay logged in
            function extendSession() {
                sessionTime = 3 * 60; // Reset to 3 minutes
                sessionWarningShown = false;
                lastWarningTime = 0;
                resetDashboardTimerVisuals();
                
                // Broadcast session extension to all tabs
                broadcastSessionExtension();
                
                Swal.fire({
                    title: '‚úÖ Session Extended',
                    text: 'Your session has been extended for another 3 minutes across all tabs.',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Log session extension activity
                logSecurityActivity('session_extension', 'Session extended by user action');
            }
            
            // Handle comprehensive session expiry cleanup
            async function handleSessionExpiry() {
                console.log('üîí Session expired - Starting comprehensive cleanup...');
                
                // Broadcast logout to all tabs first
                broadcastLogout('session_expired');
                
                // Show session expired message
                Swal.fire({
                    title: 'üîí Session Expired',
                    html: `
                        <div style="text-align: center;">
                            <div style="font-size: 64px; color: #ef4444; margin-bottom: 20px;">
                                <i class="fas fa-lock"></i>
                            </div>
                            <h3 style="color: #374151; margin-bottom: 15px;">Your session has expired</h3>
                            <p style="color: #6b7280; margin-bottom: 20px;">
                                For your security, you've been automatically logged out due to inactivity.
                            </p>
                            <div style="background: #fef2f2; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                <p style="color: #dc2626; margin: 0; font-weight: 600;">
                                    üõ°Ô∏è Clearing all session data and redirecting to login...
                                </p>
                            </div>
                        </div>
                    `,
                    icon: 'warning',
                    confirmButtonText: 'Go to Login',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        // Start cleanup immediately when dialog opens
                        setTimeout(() => {
                            performComprehensiveCleanup('session_expired');
                        }, 1000);
                    }
                }).then(() => {
                    // Ensure cleanup is complete before redirect
                    performComprehensiveCleanup('session_expired');
                });
            }
            
            // Handle manual logout
            function handleManualLogout() {
                console.log('üö™ Manual logout initiated...');
                
                // Broadcast logout to all tabs first
                broadcastLogout('manual_logout');
                
                Swal.fire({
                    title: 'Logging Out...',
                    html: 'Clearing session data and logging you out securely across all tabs...',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                        setTimeout(() => {
                            performComprehensiveCleanup('manual_logout');
                        }, 500);
                    }
                });
            }
            
            // Comprehensive cleanup function (based on Next.js session management best practices)
            async function performComprehensiveCleanup(reason = 'session_expired') {
                try {
                    console.log(`üßπ Starting comprehensive cleanup - Reason: ${reason}`);
                    
                    // Log security activity before cleanup
                    logSecurityActivity('logout', `User logged out - ${reason}`);
                    
                    // 1. Clear all localStorage data
                    try {
                        const localStorageKeys = Object.keys(localStorage);
                        localStorageKeys.forEach(key => {
                            localStorage.removeItem(key);
                        });
                        console.log('‚úÖ localStorage cleared');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è localStorage cleanup error:', e);
                    }
                    
                    // 2. Clear all sessionStorage data
                    try {
                        const sessionStorageKeys = Object.keys(sessionStorage);
                        sessionStorageKeys.forEach(key => {
                            sessionStorage.removeItem(key);
                        });
                        console.log('‚úÖ sessionStorage cleared');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è sessionStorage cleanup error:', e);
                    }
                    
                    // 3. Clear all cookies
                    try {
                        document.cookie.split(";").forEach(cookie => {
                            const eqPos = cookie.indexOf("=");
                            const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
                            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=.${window.location.hostname};secure;samesite=strict`;
                            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;secure;samesite=strict`;
                            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
                        });
                        console.log('‚úÖ Cookies cleared');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Cookie cleanup error:', e);
                    }
                    
                    // 4. Clear IndexedDB
                    try {
                        if ('indexedDB' in window) {
                            const databases = await indexedDB.databases();
                            await Promise.all(
                                databases.map(db => {
                                    if (db.name) {
                                        return new Promise((resolve) => {
                                            const deleteReq = indexedDB.deleteDatabase(db.name);
                                            deleteReq.onsuccess = () => resolve();
                                            deleteReq.onerror = () => resolve();
                                        });
                                    }
                                })
                            );
                            console.log('‚úÖ IndexedDB cleared');
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è IndexedDB cleanup error:', e);
                    }
                    
                    // 5. Clear WebSQL (deprecated but still present in some browsers)
                    try {
                        if ('openDatabase' in window) {
                            const db = window.openDatabase('', '', '', '');
                            if (db) {
                                db.transaction(tx => {
                                    tx.executeSql('DROP TABLE IF EXISTS data');
                                });
                            }
                            console.log('‚úÖ WebSQL cleared');
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è WebSQL cleanup error:', e);
                    }
                    
                    // 6. Clear Cache API
                    try {
                        if ('caches' in window) {
                            const cacheNames = await caches.keys();
                            await Promise.all(
                                cacheNames.map(cacheName => caches.delete(cacheName))
                            );
                            console.log('‚úÖ Cache API cleared');
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Cache API cleanup error:', e);
                    }
                    
                    // 7. Clear Service Worker registration
                    try {
                        if ('serviceWorker' in navigator) {
                            const registrations = await navigator.serviceWorker.getRegistrations();
                            await Promise.all(
                                registrations.map(registration => registration.unregister())
                            );
                            console.log('‚úÖ Service Workers cleared');
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Service Worker cleanup error:', e);
                    }
                    
                    // 8. Clear Application Cache (deprecated but still present)
                    try {
                        if ('applicationCache' in window && window.applicationCache.status !== window.applicationCache.UNCACHED) {
                            window.applicationCache.update();
                            console.log('‚úÖ Application Cache cleared');
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Application Cache cleanup error:', e);
                    }
                    
                    // 9. Call server-side logout endpoint
                    try {
                        await fetch('/api/auth/logout', {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json',
                                'Cache-Control': 'no-cache',
                                'Clear-Site-Data': '"cache", "cookies", "storage", "executionContexts"'
                            }
                        });
                        console.log('‚úÖ Server-side logout completed');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Server-side logout error:', e);
                    }
                    
                    // 10. Clear browser history (for security)
                    try {
                        if (window.history && window.history.replaceState) {
                            window.history.replaceState(null, null, '/login.html');
                            window.history.go(-(window.history.length - 1));
                        }
                        console.log('‚úÖ Browser history cleared');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è History cleanup error:', e);
                    }
                    
                    console.log('üéØ Comprehensive cleanup completed successfully');
                    
                    // Force redirect with cache busting
                    const timestamp = Date.now();
                    window.location.replace(`/login.html?t=${timestamp}&reason=${reason}`);
                    
                } catch (error) {
                    console.error('‚ùå Critical cleanup error:', error);
                    // Force redirect even if cleanup fails
                    window.location.replace('/login.html?error=cleanup_failed');
                }
            }
            
            // Handle browser visibility changes for security - Enhanced Minimization Detection
            function handleVisibilityChange() {
                if (document.hidden) {
                    // Browser is minimized/hidden - implement aggressive timeout for security
                    console.log('üîí Browser hidden - implementing aggressive 2-minute timeout');
                    stopSessionTimer();
                    pageHiddenStartTime = Date.now();
                    
                    // Set aggressive minimized timer - force logout after 2 minutes
                    setTimeout(() => {
                        if (document.hidden && pageHiddenStartTime) {
                            const hiddenDuration = (Date.now() - pageHiddenStartTime) / 1000 / 60; // minutes
                            console.log('üîí Security logout - browser was minimized too long');
                            handleSecurityLogout(`Browser was minimized for ${Math.round(hiddenDuration)} minutes - security timeout`);
                        }
                    }, 120000); // 2 minutes timeout when minimized
                    
                } else {
                    // Browser is visible again - resume with security checks
                    console.log('üîí Browser visible - performing security checks');
                    
                    if (pageHiddenStartTime) {
                        const hiddenDuration = (Date.now() - pageHiddenStartTime) / 1000; // seconds
                        console.log(`üîí Browser was hidden for ${Math.round(hiddenDuration)} seconds`);
                        
                        // If browser was hidden for more than 2 minutes, force logout
                        if (hiddenDuration > 120) { // 2 minutes
                            console.log('üö´ Browser was hidden too long - forcing security logout');
                            handleSecurityLogout(`Browser was minimized for ${Math.round(hiddenDuration/60)} minutes - security timeout`);
                            return;
                        }
                        
                        // Security measure: If hidden for more than 1 minute, reduce session time
                        if (hiddenDuration > 60) { // 1 minute
                            const penaltyTime = Math.min(60, Math.floor(hiddenDuration / 2)); // Max 60 second penalty
                            sessionTime = Math.max(30, sessionTime - penaltyTime); // Minimum 30 seconds left
                            console.log(`üîí Security penalty applied: ${penaltyTime} seconds deducted from session`);
                            
                            // Show security notice for significant penalties
                            if (penaltyTime > 30) {
                                Swal.fire({
                                    title: 'üîí Security Notice',
                                    html: `
                                        <div style="text-align: center;">
                                            <div style="font-size: 48px; color: #f59e0b; margin-bottom: 15px;">
                                                <i class="fas fa-shield-alt"></i>
                                            </div>
                                            <p style="color: #374151; margin-bottom: 15px;">
                                                Session time reduced for security (browser was minimized for ${Math.round(hiddenDuration)} seconds)
                                            </p>
                                        </div>
                                    `,
                                    icon: 'warning',
                                    timer: 3000,
                                    showConfirmButton: false
                                });
                            }
                        }
                        
                        pageHiddenStartTime = null;
                    }
                    
                    startSessionTimer();
                }
            }
            
            // Handle security logout with enhanced messaging
            function handleSecurityLogout(reason) {
                console.log('üîí Security logout triggered:', reason);
                
                Swal.fire({
                    title: 'üîí Security Logout',
                    html: `
                        <div style="text-align: center;">
                            <div style="font-size: 64px; color: #dc2626; margin-bottom: 20px;">
                                <i class="fas fa-lock"></i>
                            </div>
                            <h3 style="color: #374151; margin-bottom: 15px;">Session Terminated for Security</h3>
                            <div style="background: #fef2f2; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ef4444;">
                                <p style="color: #dc2626; margin: 0; font-weight: 600;">
                                    ${reason}
                                </p>
                            </div>
                            <p style="color: #6b7280; margin-bottom: 20px;">
                                This automatic logout protects your account from unauthorized access.
                            </p>
                        </div>
                    `,
                    icon: 'warning',
                    confirmButtonText: 'Continue to Login',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                }).then(() => {
                    performComprehensiveCleanup('minimized_security_logout');
                });
            }

            // Reset session timer on user activity (sync with session manager)
            function resetDashboardTimer() {
                sessionTime = 3 * 60; // Reset to 3 minutes
                sessionWarningShown = false;
                lastWarningTime = 0;
                resetDashboardTimerVisuals();
            }
            
            // Reset visual indicators
            function resetDashboardTimerVisuals() {
                if (sessionTimer) {
                    sessionTimer.style.background = 'linear-gradient(135deg, var(--accent-warning), #d97706)';
                    sessionTimer.style.animation = 'none';
                    sessionTimer.style.boxShadow = 'none';
                }
            }
            
            // Cross-tab session synchronization
            function initCrossTabSessionSync() {
                // Listen for storage changes from other tabs
                window.addEventListener('storage', function(e) {
                    // Check if logout event was triggered in another tab
                    if (e.key === 'logout_all_tabs' && e.newValue) {
                        const logoutData = JSON.parse(e.newValue);
                        if (logoutData.timestamp && (Date.now() - logoutData.timestamp) < 5000) {
                            console.log('üîÑ Cross-tab logout detected');
                            
                            // Show logout message
                            Swal.fire({
                                title: 'üîí Session Terminated',
                                html: `
                                    <div style="text-align: center;">
                                        <div style="font-size: 48px; color: #ef4444; margin-bottom: 15px;">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </div>
                                        <p style="color: #374151; margin-bottom: 15px;">
                                            Your session was terminated in another tab.
                                        </p>
                                        <p style="color: #6b7280; font-size: 14px;">
                                            Redirecting to login page...
                                        </p>
                                    </div>
                                `,
                                icon: 'warning',
                                timer: 2000,
                                showConfirmButton: false,
                                allowOutsideClick: false,
                                allowEscapeKey: false
                            }).then(() => {
                                // Quick cleanup and redirect (data already cleared by initiating tab)
                                window.location.replace('/login.html?reason=cross_tab_logout');
                            });
                        }
                    }
                    
                    // Check if session extension happened in another tab
                    if (e.key === 'session_extended' && e.newValue) {
                        const extensionData = JSON.parse(e.newValue);
                        if (extensionData.timestamp && (Date.now() - extensionData.timestamp) < 5000) {
                            console.log('üîÑ Cross-tab session extension detected');
                            // Sync session timer across tabs
                            sessionTime = 3 * 60;
                            sessionWarningShown = false;
                            lastWarningTime = 0;
                            resetDashboardTimerVisuals();
                        }
                    }
                });
                
                // Heartbeat to detect if user is active in any tab
                setInterval(() => {
                    localStorage.setItem('session_heartbeat', JSON.stringify({
                        timestamp: Date.now(),
                        tabId: Date.now() + Math.random()
                    }));
                }, 30000); // Every 30 seconds
                
                // Check for inactive tabs
                setInterval(() => {
                    const heartbeat = localStorage.getItem('session_heartbeat');
                    if (heartbeat) {
                        const data = JSON.parse(heartbeat);
                        const timeSinceLastActivity = Date.now() - data.timestamp;
                        
                        // If no activity across all tabs for more than 5 minutes, force logout
                        if (timeSinceLastActivity > 5 * 60 * 1000) {
                            console.log('üö´ All tabs inactive - forcing logout');
                            broadcastLogout('all_tabs_inactive');
                        }
                    }
                }, 60000); // Check every minute
            }
            
            // Broadcast logout to all tabs
            function broadcastLogout(reason) {
                localStorage.setItem('logout_all_tabs', JSON.stringify({
                    reason: reason,
                    timestamp: Date.now()
                }));
                
                // Clear the broadcast message after a short delay
                setTimeout(() => {
                    localStorage.removeItem('logout_all_tabs');
                }, 1000);
            }
            
            // Broadcast session extension to all tabs
            function broadcastSessionExtension() {
                localStorage.setItem('session_extended', JSON.stringify({
                    timestamp: Date.now()
                }));
                
                // Clear the broadcast message after a short delay
                setTimeout(() => {
                    localStorage.removeItem('session_extended');
                }, 1000);
            }

            // Add activity listeners to reset dashboard timer
            document.addEventListener('mousemove', resetDashboardTimer);
            document.addEventListener('keydown', resetDashboardTimer);
            document.addEventListener('click', resetDashboardTimer);
            document.addEventListener('scroll', resetDashboardTimer);
            
            // Cross-tab session synchronization
            initCrossTabSessionSync();

            // Initialize dashboard
            if (typeof initDashboard === 'function') {
                initDashboard();
            }

            // Add event listeners for buttons (CSP compliant)
            const editProfileBtn = document.getElementById('editProfileBtn');
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', editProfile);
            }

            const viewSecurityLogsBtn = document.getElementById('viewSecurityLogsBtn');
            if (viewSecurityLogsBtn) {
                viewSecurityLogsBtn.addEventListener('click', viewSecurityLogs);
            }

            const viewAllActivityBtn = document.getElementById('viewAllActivityBtn');
            if (viewAllActivityBtn) {
                viewAllActivityBtn.addEventListener('click', viewAllActivity);
            }

            const downloadLogsBtn = document.getElementById('downloadLogsBtn');
            if (downloadLogsBtn) {
                downloadLogsBtn.addEventListener('click', downloadLogs);
            }

            const exportDataBtn = document.getElementById('exportDataBtn');
            if (exportDataBtn) {
                exportDataBtn.addEventListener('click', exportData);
            }

            const contactSupportBtn = document.getElementById('contactSupportBtn');
            if (contactSupportBtn) {
                contactSupportBtn.addEventListener('click', contactSupport);
            }

            const viewAllSessionsBtn = document.getElementById('viewAllSessionsBtn');
            if (viewAllSessionsBtn) {
                viewAllSessionsBtn.addEventListener('click', viewAllSessions);
            }

            const endOtherSessionsBtn = document.getElementById('endOtherSessionsBtn');
            if (endOtherSessionsBtn) {
                endOtherSessionsBtn.addEventListener('click', endOtherSessions);
            }

            const changePasswordBtn = document.getElementById('changePasswordBtn');
            if (changePasswordBtn) {
                changePasswordBtn.addEventListener('click', changePassword);
            }

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogoutClick);
            }

            // Load current session information
            loadCurrentSessionInfo();
            
            // Test API connectivity first
            testApiConnectivity().then(() => {
                // Load real-time recent activity data
                loadRecentActivity();
            }).catch(error => {
                console.error('API connectivity test failed:', error);
                showActivityLoadError('API connection failed. Please check your login status.');
            });
            
            // Start real-time password expiry tracking
            startPasswordExpiryChecker().catch(error => {
                console.error('Error starting password expiry checker:', error);
            });

            // Start comprehensive notification updates (every 3 minutes)
            setInterval(async () => {
                try {
                    await updateComprehensiveNotifications();
                    console.log('üîî Periodic notification update completed');
                } catch (error) {
                    console.error('Error in periodic notification update:', error);
                }
            }, 180000); // 3 minutes

            // Start real-time activity refresh (every 2 minutes)
            setInterval(async () => {
                try {
                    await loadRecentActivity();
                    console.log('üîÑ Real-time activity refresh completed');
                } catch (error) {
                    console.error('Error in real-time activity refresh:', error);
                }
            }, 120000); // 2 minutes

            // Update last active timestamp every 30 seconds for real-time tracking
            setInterval(async () => {
                try {
                    const token = localStorage.getItem('token');
                    if (token) {
                        await fetch('/api/user/info', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        console.log('‚è±Ô∏è Activity timestamp updated');
                    }
                } catch (error) {
                    console.error('Error updating activity timestamp:', error);
                }
            }, 30000); // 30 seconds
        });

        // Dashboard action functions
        function editProfile() {
            Swal.fire({
                title: 'Edit Profile',
                html: `
                    <div style="text-align: left;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Display Name:</label>
                        <input type="text" id="displayName" class="swal2-input" placeholder="Enter display name">
                        <label style="display: block; margin-bottom: 5px; margin-top: 15px; font-weight: 600;">Bio:</label>
                        <textarea id="bio" class="swal2-textarea" placeholder="Tell us about yourself"></textarea>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Save Changes',
                preConfirm: () => {
                    const displayName = document.getElementById('displayName').value;
                    const bio = document.getElementById('bio').value;
                    return { displayName, bio };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire('Success!', 'Profile updated successfully.', 'success');
                }
            });
        }

        async function viewSecurityLogs() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('No authentication token found. Please log in again.');
                }

                console.log('[Security Logs] Fetching security logs...');
                
                const response = await fetch('/api/user/logs', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('[Security Logs] Response received:', data);

                // Display security logs
                displaySecurityLogs(data.activities || []);

            } catch (error) {
                console.error('[Security Logs] Error:', error);
                Swal.fire('Error', 'Failed to load security logs. Please try again.', 'error');
            }
        }

        // Initialize session timer with enhanced browser minimization detection
        function initSecureSessionTimer() {
            // Start the timer
            startSessionTimer();
            
            // Add visibility change listener for security
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            console.log('üîí Secure session timer initialized with enhanced browser minimization detection');
        }
        
        // Start the session timer
        function startSessionTimer() {
            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
            }
            sessionTimerInterval = setInterval(updateSessionTimer, 1000);
        }
        
        // Stop the session timer
        function stopSessionTimer() {
            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
                sessionTimerInterval = null;
            }
        }
        
        // Page visibility tracking variables
        let sessionTimerInterval = null;
        let pageHiddenStartTime = null;
        
        // Initialize secure session timer
        initSecureSessionTimer();
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Dashboard-specific styles using the modern design system */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            font-family: var(--font-family);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-overlay);
            z-index: -1;
        }

        .dashboard-wrapper {
            min-height: 100vh;
            padding: var(--space-4);
        }

        /* Header */
        .dashboard-header {
            background: var(--bg-primary);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            padding: var(--space-8);
            margin-bottom: var(--space-8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-4);
            border: 1px solid var(--gray-200);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .dashboard-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            color: var(--gray-900);
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .dashboard-title i {
            color: var(--primary-color);
            font-size: 1.75rem;
        }

        .user-welcome {
            color: var(--gray-600);
            font-size: 1rem;
            margin: var(--space-1) 0 0 0;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .session-timer {
            background: linear-gradient(135deg, var(--accent-warning), #d97706);
            color: white;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .notification-btn {
            position: relative;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-md);
        }

        .notification-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--accent-danger);
            color: white;
            border-radius: var(--radius-full);
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .logout-btn {
            background: var(--accent-danger);
            color: white;
            border: none;
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            box-shadow: var(--shadow-md);
        }

        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* Main Grid Layout */
        .dashboard-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: var(--space-8);
            margin-bottom: var(--space-8);
        }

        /* Cards */
        .dashboard-card {
            background: var(--bg-primary);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            padding: var(--space-8);
            border: 1px solid var(--gray-200);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            z-index: 1;
        }

        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-2xl);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--gray-200);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .card-icon.user { background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); }
        .card-icon.security { background: linear-gradient(135deg, var(--accent-color), #059669); }
        .card-icon.activity { background: linear-gradient(135deg, var(--accent-warning), #d97706); }
        .card-icon.settings { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .card-icon.analytics { background: linear-gradient(135deg, var(--accent-info), #0891b2); }

        .card-title {
            color: var(--gray-900);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        /* Info Items */
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4) 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: var(--gray-700);
            font-size: 1rem;
        }

        .info-value {
            color: var(--gray-600);
            font-weight: 500;
            font-size: 1rem;
        }

        /* Status Badges */
        .status-badge {
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-verified {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-color);
        }

        .status-unverified {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-danger);
        }

        .status-active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-color);
        }

        .status-inactive {
            background: rgba(107, 114, 128, 0.1);
            color: var(--gray-500);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--space-4);
            margin: var(--space-6) 0;
        }

        .stat-item {
            text-align: center;
            padding: var(--space-6);
            background: var(--gray-50);
            border-radius: var(--radius-xl);
            border: 1px solid var(--gray-200);
            transition: all var(--transition-fast);
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: var(--space-2);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray-600);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: var(--space-3);
            margin-top: var(--space-6);
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            min-width: 140px;
            padding: var(--space-4) var(--space-6);
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            text-decoration: none;
            box-shadow: var(--shadow-md);
        }

        .action-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .action-btn.primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .action-btn.secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-200);
        }

        .action-btn.secondary:hover {
            background: var(--gray-200);
            border-color: var(--gray-300);
        }

        .action-btn.success {
            background: var(--accent-color);
            color: white;
        }

        .action-btn.success:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .action-btn.warning {
            background: var(--accent-warning);
            color: white;
        }

        .action-btn.warning:hover {
            background: #d97706;
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: var(--space-6) 0;
        }

        /* Activity Log */
        .activity-log {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-3);
            transition: all var(--transition-fast);
        }

        .activity-item:hover {
            background: var(--gray-50);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            flex-shrink: 0;
        }

        .activity-icon.login { background: var(--accent-color); }
        .activity-icon.logout { background: var(--accent-danger); }
        .activity-icon.update { background: var(--accent-warning); }
        .activity-icon.security { background: var(--primary-color); }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: var(--gray-900);
            font-size: 0.95rem;
            margin-bottom: var(--space-1);
        }

        .activity-time {
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        /* Loading States */
        #loadingSpinner {
            display: none;
            text-align: center;
            padding: var(--space-20);
            background: var(--bg-primary);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--gray-200);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid var(--gray-200);
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-6);
        }

        .loading-text {
            color: var(--gray-600);
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Error Message */
        #errorMessage {
            display: none;
            background: var(--bg-primary);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-left: 4px solid var(--accent-danger);
            color: var(--accent-danger);
            padding: var(--space-8);
            border-radius: var(--radius-2xl);
            margin: var(--space-8) 0;
            text-align: center;
            box-shadow: var(--shadow-xl);
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* Notification Dropdown */
        .notification-dropdown {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-2xl);
            width: 400px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            border: 1px solid var(--gray-200);
            animation: slideDown 0.3s ease-out;
        }

        .notification-dropdown.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--gray-200);
            font-weight: 700;
            color: var(--gray-900);
            text-align: center;
        }

        .notification-item {
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--gray-100);
            transition: background var(--transition-fast);
            cursor: pointer;
        }

        .notification-item:hover {
            background: var(--gray-50);
        }

        .notification-item.unread {
            background: rgba(37, 99, 235, 0.05);
            border-left: 4px solid var(--primary-color);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-wrapper {
                padding: var(--space-3);
            }
            
            .dashboard-header {
                flex-direction: column;
            text-align: center;
                padding: var(--space-6);
            }
            
            .header-actions {
                width: 100%;
                justify-content: center;
            }
            
        .dashboard-card {
                padding: var(--space-6);
            }
            
        .action-buttons {
                flex-direction: column;
        }

        .action-btn {
            width: 100%;
            }
            
        .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .dashboard-title {
                font-size: 1.5rem;
                flex-direction: column; 
                gap: var(--space-2);
            }
            
            .stats-grid {
                grid-template-columns: 1fr; 
            }
            
            .header-actions {
            flex-direction: column;
                gap: var(--space-3);
            }
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-wrapper">
        <!-- Loading Spinner -->
        <div id="loadingSpinner">
            <div class="spinner"></div>
            <div class="loading-text">Loading your dashboard...</div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage"></div>

        <!-- Dashboard Header -->
        <header id="dashboardHeader" class="dashboard-header" style="display: none;">
            <div class="header-left">
            <div>
                <h1 class="dashboard-title">
                        <i class="fas fa-shield-halved" aria-hidden="true"></i>
                        Secure Dashboard
                </h1>
                    <p id="userWelcome" class="user-welcome">Welcome back, User!</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="session-timer">
                    <i class="fas fa-clock" aria-hidden="true"></i>
                    <span id="sessionTimer">29:45</span>
                </div>
                <button class="notification-btn" id="notificationBtn" aria-label="Notifications">
                    <i class="fas fa-bell" aria-hidden="true"></i>
                    <span class="notification-badge" id="notificationBadge">3</span>
                    </button>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                    Logout
                </button>
            </div>
        </header>

        <!-- Main Dashboard Content -->
        <main id="dashboardContent" class="dashboard-content" style="display: none;">
            <!-- User Profile Card -->
            <section class="dashboard-card fade-in">
                <div class="card-header">
                    <div class="card-icon user">
                        <i class="fas fa-user" aria-hidden="true"></i>
                    </div>
                    <h2 class="card-title">Profile Information</h2>
                </div>
                <div id="userProfileContent">
                    <div class="info-item">
                        <span class="info-label">Username</span>
                        <span class="info-value">Loading...</span>
                </div>
                    <div class="info-item">
                        <span class="info-label">Email</span>
                        <span class="info-value">Loading...</span>
            </div>
                    <div class="info-item">
                        <span class="info-label">Account Status</span>
                        <span id="accountStatus" class="status-badge status-verified">Verified</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Member Since</span>
                        <span id="accountCreated" class="info-value">Loading...</span>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="action-btn secondary" id="editProfileBtn">
                        <i class="fas fa-edit" aria-hidden="true"></i>
                        Edit Profile
                    </button>
                </div>
            </section>

            <!-- Current Session Info -->
            <section class="dashboard-card fade-in">
                <div class="card-header">
                    <div class="card-icon security">
                        <i class="fas fa-desktop" aria-hidden="true"></i>
                    </div>
                    <h2 class="card-title">Current Session</h2>
                </div>
                    <div class="info-item">
                    <span class="info-label">Device Type</span>
                    <span class="info-value" id="currentDeviceType">Desktop Computer</span>
                    </div>
                    <div class="info-item">
                    <span class="info-label">Browser</span>
                    <span class="info-value" id="currentBrowser">Loading...</span>
                    </div>
                    <div class="info-item">
                    <span class="info-label">Operating System</span>
                    <span class="info-value" id="currentOS">Loading...</span>
                    </div>
                    <div class="info-item">
                    <span class="info-label">IP Address</span>
                    <span class="info-value" id="currentIP">Loading...</span>
                    </div>
                    <div class="info-item">
                    <span class="info-label">Location</span>
                    <span class="info-value" id="currentLocation">Loading...</span>
                    </div>
                <div class="info-item">
                    <span class="info-label">Session Started</span>
                    <span class="info-value" id="sessionStartTime">Loading...</span>
                </div>
                        <div class="action-buttons">
                    <button class="action-btn warning" id="viewAllSessionsBtn">
                        <i class="fas fa-list" aria-hidden="true"></i>
                        View All Sessions
                            </button>
                    <button class="action-btn secondary" id="endOtherSessionsBtn">
                        <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                        End Other Sessions
                            </button>
                        </div>
            </section>

            <!-- Security Overview -->
            <section class="dashboard-card fade-in">
                <div class="card-header">
                    <div class="card-icon security">
                        <i class="fas fa-shield-alt" aria-hidden="true"></i>
                    </div>
                    <h2 class="card-title">Security Overview</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">5</div>
                        <div class="stat-label">Login Attempts</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">2</div>
                        <div class="stat-label">Failed Attempts</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">24h</div>
                        <div class="stat-label">Last Login</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">98%</div>
                        <div class="stat-label">Security Score</div>
                    </div>
                </div>
                <div class="info-item">
                    <span class="info-label">Two-Factor Authentication</span>
                    <span class="status-badge status-active">Enabled</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Email Verification</span>
                    <span class="status-badge status-active">Verified</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Password Expires On</span>
                    <span class="info-value" id="passwordExpiryDate">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Days Until Expiry</span>
                    <span class="info-value" id="passwordDaysLeft">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Last Security Check</span>
                    <span class="info-value" id="lastLoginTime">Loading...</span>
                </div>
                <div class="action-buttons">
                    <button class="action-btn warning" id="viewSecurityLogsBtn">
                        <i class="fas fa-history" aria-hidden="true"></i>
                        Security Logs
                    </button>
                    <button class="action-btn primary" id="changePasswordBtn">
                        <i class="fas fa-key" aria-hidden="true"></i>
                        Change Password Now
                    </button>
                </div>
            </section>

            <!-- Analytics Chart -->
            <section class="dashboard-card fade-in">
                <div class="card-header">
                    <div class="card-icon analytics">
                        <i class="fas fa-chart-line" aria-hidden="true"></i>
                    </div>
                    <h2 class="card-title">Login Analytics</h2>
                </div>
                <div class="chart-container">
                    <canvas id="loginChart"></canvas>
                </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                        <div class="stat-number">156</div>
                        <div class="stat-label">Total Logins</div>
                        </div>
                        <div class="stat-item">
                        <div class="stat-number">12</div>
                        <div class="stat-label">This Week</div>
                        </div>
                    <div class="stat-item">
                        <div class="stat-number">3.2</div>
                        <div class="stat-label">Avg/Day</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">99.2%</div>
                        <div class="stat-label">Success Rate</div>
                </div>
            </div>
            </section>

            <!-- Recent Activity -->
            <section class="dashboard-card fade-in">
                <div class="card-header">
                    <div class="card-icon activity">
                        <i class="fas fa-clock" aria-hidden="true"></i>
                    </div>
                    <h2 class="card-title">Recent Activity</h2>
                </div>
                <div class="activity-log" id="recentActivityContainer">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Loading recent activity...</div>
                            <div class="activity-time">Please wait</div>
                        </div>
                    </div>
                </div>
                    <div class="action-buttons">
                    <button class="action-btn secondary" id="viewAllActivityBtn">
                        <i class="fas fa-list" aria-hidden="true"></i>
                        View All Activity
                        </button>
                    <button class="action-btn secondary" id="downloadLogsBtn">
                        <i class="fas fa-download" aria-hidden="true"></i>
                        Download Logs
                        </button>
                    </div>
            </section>

            <!-- Quick Actions -->
            <section class="dashboard-card fade-in">
                <div class="card-header">
                    <div class="card-icon settings">
                        <i class="fas fa-cogs" aria-hidden="true"></i>
                    </div>
                    <h2 class="card-title">Quick Actions</h2>
                </div>
                    <!-- Removed duplicate Change Password button -->
                <div class="action-buttons">
                    <button class="action-btn secondary" id="exportDataBtn">
                        <i class="fas fa-file-export" aria-hidden="true"></i>
                        Export Data
                        </button>
                    <button class="action-btn secondary" id="contactSupportBtn">
                        <i class="fas fa-support" aria-hidden="true"></i>
                        Support
                        </button>
                    </div>
                <div class="info-item" style="margin-top: 1.5rem;">
                    <span class="info-label">Account Created</span>
                    <span class="info-value" id="memberSince">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Data Usage</span>
                    <span class="info-value">2.3 MB</span>
            </div>
                <div class="info-item">
                    <span class="info-label">Storage Used</span>
                    <span class="info-value">156 KB</span>
        </div>
            </section>
        </main>

        <!-- Notification Dropdown -->
        <div id="notificationDropdown" class="notification-dropdown">
            <div class="notification-header">
                <h3>Notifications</h3>
            </div>
            <div class="notification-item unread">
                <div style="font-weight: 600; margin-bottom: 4px;">Security Alert</div>
                <div style="font-size: 0.9rem; color: #666;">New login detected from Chrome on Windows</div>
                <div style="font-size: 0.8rem; color: #999; margin-top: 4px;">2 hours ago</div>
            </div>
                        <div class="notification-item unread">
                <div style="font-weight: 600; margin-bottom: 4px;">Password Expiry Warning</div>
                <div style="font-size: 0.9rem; color: #666;">Your password will expire in 15 days (30-day policy)</div>
                <div style="font-size: 0.8rem; color: #999; margin-top: 4px;">1 day ago</div>
            </div>
            <div class="notification-item">
                <div style="font-weight: 600; margin-bottom: 4px;">Account Updated</div>
                <div style="font-size: 0.9rem; color: #666;">Profile information successfully updated</div>
                <div style="font-size: 0.8rem; color: #999; margin-top: 4px;">3 days ago</div>
    </div>
                    </div>
                    </div>

    <!-- Scripts -->
    <script src="js/utils.js?v=1.0.4"></script>
    <script src="js/session-manager.js?v=1.0.4"></script>
    <script src="js/dashboard.js?v=1.0.4"></script>
    
    <script>
        // Enhanced dashboard functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Chart.js for analytics
            const ctx = document.getElementById('loginChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Daily Logins',
                            data: [12, 19, 3, 5, 2, 3, 10],
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#f1f5f9'
                                }
                            },
                            x: {
                                grid: {
                                    color: '#f1f5f9'
                                }
                            }
                        }
                    }
                });
            }

            // Notification dropdown toggle
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.getElementById('notificationDropdown');
            
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    notificationDropdown.classList.toggle('show');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!notificationDropdown.contains(e.target)) {
                        notificationDropdown.classList.remove('show');
                    }
                });
            }

                        // Session timer functionality (Updated to 3 minutes with comprehensive cleanup)
            let sessionTime = 3 * 60; // 3 minutes in seconds (updated from 30 minutes)
            let sessionWarningShown = false;
            let lastWarningTime = 0;
            const sessionTimer = document.getElementById('sessionTimer');
            
            function updateSessionTimer() {
                const minutes = Math.floor(sessionTime / 60);
                const seconds = sessionTime % 60;
                if (sessionTimer) {
                    sessionTimer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Progressive visual warnings
                    if (sessionTime <= 30) { // Last 30 seconds - critical warning
                        sessionTimer.style.background = 'linear-gradient(135deg, #dc2626, #991b1b)';
                        sessionTimer.style.animation = 'pulse 0.5s infinite';
                        sessionTimer.style.boxShadow = '0 0 20px rgba(220, 38, 38, 0.5)';
                    } else if (sessionTime <= 60) { // Last minute warning
                        sessionTimer.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                        sessionTimer.style.animation = 'pulse 1s infinite';
                        sessionTimer.style.boxShadow = '0 0 15px rgba(239, 68, 68, 0.3)';
                    } else if (sessionTime <= 120) { // Last 2 minutes warning
                        sessionTimer.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                        sessionTimer.style.boxShadow = '0 0 10px rgba(245, 158, 11, 0.2)';
                    }
                    
                    // Show warning dialogs at specific intervals
                    if (sessionTime === 60 && !sessionWarningShown) {
                        showSessionWarning(60);
                        sessionWarningShown = true;
                        lastWarningTime = 60;
                    } else if (sessionTime === 30 && lastWarningTime !== 30) {
                        showSessionWarning(30);
                        lastWarningTime = 30;
                    } else if (sessionTime === 10 && lastWarningTime !== 10) {
                        showSessionWarning(10);
                        lastWarningTime = 10;
                    }
                }
                
                if (sessionTime <= 0) {
                    handleSessionExpiry();
                    return;
                }
                
                sessionTime--;
            }
            
            // Show session warning with option to extend
            function showSessionWarning(timeLeft) {
                const timeText = timeLeft === 60 ? '1 minute' : `${timeLeft} seconds`;
                
                Swal.fire({
                    title: '‚è∞ Session Expiring Soon',
                    html: `
                        <div style="text-align: center;">
                            <div style="font-size: 48px; color: #f59e0b; margin-bottom: 15px;">
                                <i class="fas fa-clock"></i>
                            </div>
                            <p style="font-size: 16px; margin-bottom: 15px; color: #374151;">
                                Your session will expire in <strong style="color: #dc2626;">${timeText}</strong>
                            </p>
                            <p style="color: #6b7280; margin-bottom: 20px;">
                                Click "Stay Logged In" to extend your session, or "Logout" to end it now.
                            </p>
                            <div style="background: #fef3c7; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                <small style="color: #92400e;">
                                    üí° <strong>Security Tip:</strong> Sessions automatically expire for your protection.
                                </small>
                            </div>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Stay Logged In',
                    cancelButtonText: 'Logout Now',
                    allowOutsideClick: false,
                    confirmButtonColor: '#10b981',
                    cancelButtonColor: '#ef4444',
                    timer: timeLeft * 1000,
                    timerProgressBar: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        extendSession();
                    } else if (result.dismiss === Swal.DismissReason.cancel) {
                        handleManualLogout();
                    } else if (result.dismiss === Swal.DismissReason.timer) {
                        handleSessionExpiry();
                    }
                });
            }
            
            // Extend session when user chooses to stay logged in
            function extendSession() {
                sessionTime = 3 * 60; // Reset to 3 minutes
                sessionWarningShown = false;
                lastWarningTime = 0;
                resetDashboardTimerVisuals();
                
                // Broadcast session extension to all tabs
                broadcastSessionExtension();
                
                Swal.fire({
                    title: '‚úÖ Session Extended',
                    text: 'Your session has been extended for another 3 minutes across all tabs.',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Log session extension activity
                logSecurityActivity('session_extension', 'Session extended by user action');
            }
            
            // Handle comprehensive session expiry cleanup
            async function handleSessionExpiry() {
                console.log('üîí Session expired - Starting comprehensive cleanup...');
                
                // Broadcast logout to all tabs first
                broadcastLogout('session_expired');
                
                // Show session expired message
                Swal.fire({
                    title: 'üîí Session Expired',
                    html: `
                        <div style="text-align: center;">
                            <div style="font-size: 64px; color: #ef4444; margin-bottom: 20px;">
                                <i class="fas fa-lock"></i>
                            </div>
                            <h3 style="color: #374151; margin-bottom: 15px;">Your session has expired</h3>
                            <p style="color: #6b7280; margin-bottom: 20px;">
                                For your security, you've been automatically logged out due to inactivity.
                            </p>
                            <div style="background: #fef2f2; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                <p style="color: #dc2626; margin: 0; font-weight: 600;">
                                    üõ°Ô∏è Clearing all session data and redirecting to login...
                                </p>
                            </div>
                        </div>
                    `,
                    icon: 'warning',
                    confirmButtonText: 'Go to Login',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        // Start cleanup immediately when dialog opens
                        setTimeout(() => {
                            performComprehensiveCleanup('session_expired');
                        }, 1000);
                    }
                }).then(() => {
                    // Ensure cleanup is complete before redirect
                    performComprehensiveCleanup('session_expired');
                });
            }
            
            // Handle manual logout
            function handleManualLogout() {
                console.log('üö™ Manual logout initiated...');
                
                // Broadcast logout to all tabs first
                broadcastLogout('manual_logout');
                
                Swal.fire({
                    title: 'Logging Out...',
                    html: 'Clearing session data and logging you out securely across all tabs...',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                        setTimeout(() => {
                            performComprehensiveCleanup('manual_logout');
                        }, 500);
                    }
                });
            }
            
            // Comprehensive cleanup function (based on Next.js session management best practices)
            async function performComprehensiveCleanup(reason = 'session_expired') {
                try {
                    console.log(`üßπ Starting comprehensive cleanup - Reason: ${reason}`);
                    
                    // Log security activity before cleanup
                    logSecurityActivity('logout', `User logged out - ${reason}`);
                    
                    // 1. Clear all localStorage data
                    try {
                        const localStorageKeys = Object.keys(localStorage);
                        localStorageKeys.forEach(key => {
                            localStorage.removeItem(key);
                        });
                        console.log('‚úÖ localStorage cleared');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è localStorage cleanup error:', e);
                    }
                    
                    // 2. Clear all sessionStorage data
                    try {
                        const sessionStorageKeys = Object.keys(sessionStorage);
                        sessionStorageKeys.forEach(key => {
                            sessionStorage.removeItem(key);
                        });
                        console.log('‚úÖ sessionStorage cleared');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è sessionStorage cleanup error:', e);
                    }
                    
                    // 3. Clear all cookies
                    try {
                        document.cookie.split(";").forEach(cookie => {
                            const eqPos = cookie.indexOf("=");
                            const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
                            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=.${window.location.hostname};secure;samesite=strict`;
                            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;secure;samesite=strict`;
                            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
                        });
                        console.log('‚úÖ Cookies cleared');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Cookie cleanup error:', e);
                    }
                    
                    // 4. Clear IndexedDB
                    try {
                        if ('indexedDB' in window) {
                            const databases = await indexedDB.databases();
                            await Promise.all(
                                databases.map(db => {
                                    if (db.name) {
                                        return new Promise((resolve) => {
                                            const deleteReq = indexedDB.deleteDatabase(db.name);
                                            deleteReq.onsuccess = () => resolve();
                                            deleteReq.onerror = () => resolve();
                                        });
                                    }
                                })
                            );
                            console.log('‚úÖ IndexedDB cleared');
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è IndexedDB cleanup error:', e);
                    }
                    
                    // 5. Clear WebSQL (deprecated but still present in some browsers)
                    try {
                        if ('openDatabase' in window) {
                            const db = window.openDatabase('', '', '', '');
                            if (db) {
                                db.transaction(tx => {
                                    tx.executeSql('DROP TABLE IF EXISTS data');
                                });
                            }
                            console.log('‚úÖ WebSQL cleared');
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è WebSQL cleanup error:', e);
                    }
                    
                    // 6. Clear Cache API
                    try {
                        if ('caches' in window) {
                            const cacheNames = await caches.keys();
                            await Promise.all(
                                cacheNames.map(cacheName => caches.delete(cacheName))
                            );
                            console.log('‚úÖ Cache API cleared');
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Cache API cleanup error:', e);
                    }
                    
                    // 7. Clear Service Worker registration
                    try {
                        if ('serviceWorker' in navigator) {
                            const registrations = await navigator.serviceWorker.getRegistrations();
                            await Promise.all(
                                registrations.map(registration => registration.unregister())
                            );
                            console.log('‚úÖ Service Workers cleared');
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Service Worker cleanup error:', e);
                    }
                    
                    // 8. Clear Application Cache (deprecated but still present)
                    try {
                        if ('applicationCache' in window && window.applicationCache.status !== window.applicationCache.UNCACHED) {
                            window.applicationCache.update();
                            console.log('‚úÖ Application Cache cleared');
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Application Cache cleanup error:', e);
                    }
                    
                    // 9. Call server-side logout endpoint
                    try {
                        await fetch('/api/auth/logout', {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json',
                                'Cache-Control': 'no-cache',
                                'Clear-Site-Data': '"cache", "cookies", "storage", "executionContexts"'
                            }
                        });
                        console.log('‚úÖ Server-side logout completed');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Server-side logout error:', e);
                    }
                    
                    // 10. Clear browser history (for security)
                    try {
                        if (window.history && window.history.replaceState) {
                            window.history.replaceState(null, null, '/login.html');
                            window.history.go(-(window.history.length - 1));
                        }
                        console.log('‚úÖ Browser history cleared');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è History cleanup error:', e);
                    }
                    
                    console.log('üéØ Comprehensive cleanup completed successfully');
                    
                    // Force redirect with cache busting
                    const timestamp = Date.now();
                    window.location.replace(`/login.html?t=${timestamp}&reason=${reason}`);
                    
                } catch (error) {
                    console.error('‚ùå Critical cleanup error:', error);
                    // Force redirect even if cleanup fails
                    window.location.replace('/login.html?error=cleanup_failed');
                }
            }
            
            // Log security activities
            function logSecurityActivity(type, description) {
                try {
                    const activity = {
                        type: type,
                        description: description,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        ip: document.getElementById('currentIP')?.textContent || 'Unknown',
                        sessionId: localStorage.getItem('currentSessionId') || 'Unknown'
                    };
                    
                    const existingLogs = JSON.parse(localStorage.getItem('securityLogs') || '[]');
                    existingLogs.push(activity);
                    
                    // Keep only last 100 activities
                    if (existingLogs.length > 100) {
                        existingLogs.splice(0, existingLogs.length - 100);
                    }
                    
                    localStorage.setItem('securityLogs', JSON.stringify(existingLogs));
                } catch (e) {
                    console.warn('Security logging error:', e);
                }
            }
            
            // Page visibility tracking for session security
            let sessionTimerInterval = null;
            let pageHiddenStartTime = null;
            
            // Initialize session timer with visibility awareness
            function initSecureSessionTimer() {
                // Start the timer
                startSessionTimer();
                
                // Add visibility change listener for security
                document.addEventListener('visibilitychange', handleVisibilityChange);
                
                console.log('üîí Secure session timer initialized with browser visibility detection');
            }
            
            // Start the session timer
            function startSessionTimer() {
                if (sessionTimerInterval) {
                    clearInterval(sessionTimerInterval);
                }
                sessionTimerInterval = setInterval(updateSessionTimer, 1000);
            }
            
            // Stop the session timer
            function stopSessionTimer() {
                if (sessionTimerInterval) {
                    clearInterval(sessionTimerInterval);
                    sessionTimerInterval = null;
                }
            }
            
            // Handle browser visibility changes for security
            function handleVisibilityChange() {
                if (document.hidden) {
                    // Browser is minimized/hidden - pause timer for security
                    console.log('üîí Browser hidden - pausing session timer for security');
                    stopSessionTimer();
                    pageHiddenStartTime = Date.now();
                    
                    // Log security event
                    logSecurityActivity('browser_hidden', 'Browser minimized/hidden - session timer paused');
                } else {
                    // Browser is visible again - resume timer with security check
                    console.log('üîí Browser visible - resuming session timer');
                    
                    if (pageHiddenStartTime) {
                        const hiddenDuration = (Date.now() - pageHiddenStartTime) / 1000; // seconds
                        console.log(`üîí Browser was hidden for ${Math.round(hiddenDuration)} seconds`);
                        
                        // Security measure: If hidden for more than 2 minutes, reduce session time
                        if (hiddenDuration > 120) { // 2 minutes
                            const penaltyTime = Math.min(60, Math.floor(hiddenDuration / 2)); // Max 60 second penalty
                            sessionTime = Math.max(30, sessionTime - penaltyTime); // Minimum 30 seconds left
                            console.log(`üîí Security penalty applied: ${penaltyTime} seconds deducted from session`);
                            
                            logSecurityActivity('session_penalty', `Session time reduced by ${penaltyTime}s due to extended inactivity`);
                            
                            // Show security notice if penalty was significant
                            if (penaltyTime > 30) {
                                Swal.fire({
                                    title: 'üîí Security Notice',
                                    html: `
                                        <div style="text-align: center;">
                                            <div style="font-size: 48px; color: #f59e0b; margin-bottom: 15px;">
                                                <i class="fas fa-shield-alt"></i>
                                            </div>
                                            <p style="color: #374151; margin-bottom: 15px;">
                                                Your session time has been reduced for security.
                                            </p>
                                            <p style="color: #6b7280; font-size: 14px;">
                                                The browser was inactive for ${Math.round(hiddenDuration)} seconds.
                                            </p>
                                        </div>
                                    `,
                                    icon: 'warning',
                                    timer: 3000,
                                    showConfirmButton: false
                                });
                            }
                        }
                        
                        pageHiddenStartTime = null;
                    }
                    
                    startSessionTimer();
                    logSecurityActivity('browser_visible', 'Browser restored - session timer resumed');
                }
            }
            
            // Initialize secure session timer
            initSecureSessionTimer();

            // Reset session timer on user activity (sync with session manager)
            function resetDashboardTimer() {
                sessionTime = 3 * 60; // Reset to 3 minutes
                sessionWarningShown = false;
                lastWarningTime = 0;
                resetDashboardTimerVisuals();
            }
            
            // Reset visual indicators
            function resetDashboardTimerVisuals() {
                if (sessionTimer) {
                    sessionTimer.style.background = 'linear-gradient(135deg, var(--accent-warning), #d97706)';
                    sessionTimer.style.animation = 'none';
                    sessionTimer.style.boxShadow = 'none';
                }
            }
            
            // Cross-tab session synchronization
            function initCrossTabSessionSync() {
                // Listen for storage changes from other tabs
                window.addEventListener('storage', function(e) {
                    // Check if logout event was triggered in another tab
                    if (e.key === 'logout_all_tabs' && e.newValue) {
                        const logoutData = JSON.parse(e.newValue);
                        if (logoutData.timestamp && (Date.now() - logoutData.timestamp) < 5000) {
                            console.log('üîÑ Cross-tab logout detected');
                            
                            // Show logout message
                            Swal.fire({
                                title: 'üîí Session Terminated',
                                html: `
                                    <div style="text-align: center;">
                                        <div style="font-size: 48px; color: #ef4444; margin-bottom: 15px;">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </div>
                                        <p style="color: #374151; margin-bottom: 15px;">
                                            Your session was terminated in another tab.
                                        </p>
                                        <p style="color: #6b7280; font-size: 14px;">
                                            Redirecting to login page...
                                        </p>
                                    </div>
                                `,
                                icon: 'warning',
                                timer: 2000,
                                showConfirmButton: false,
                                allowOutsideClick: false,
                                allowEscapeKey: false
                            }).then(() => {
                                // Quick cleanup and redirect (data already cleared by initiating tab)
                                window.location.replace('/login.html?reason=cross_tab_logout');
                            });
                        }
                    }
                    
                    // Check if session extension happened in another tab
                    if (e.key === 'session_extended' && e.newValue) {
                        const extensionData = JSON.parse(e.newValue);
                        if (extensionData.timestamp && (Date.now() - extensionData.timestamp) < 5000) {
                            console.log('üîÑ Cross-tab session extension detected');
                            // Sync session timer across tabs
                            sessionTime = 3 * 60;
                            sessionWarningShown = false;
                            lastWarningTime = 0;
                            resetDashboardTimerVisuals();
                        }
                    }
                });
                
                // Heartbeat to detect if user is active in any tab
                setInterval(() => {
                    localStorage.setItem('session_heartbeat', JSON.stringify({
                        timestamp: Date.now(),
                        tabId: Date.now() + Math.random()
                    }));
                }, 30000); // Every 30 seconds
                
                // Check for inactive tabs
                setInterval(() => {
                    const heartbeat = localStorage.getItem('session_heartbeat');
                    if (heartbeat) {
                        const data = JSON.parse(heartbeat);
                        const timeSinceLastActivity = Date.now() - data.timestamp;
                        
                        // If no activity across all tabs for more than 5 minutes, force logout
                        if (timeSinceLastActivity > 5 * 60 * 1000) {
                            console.log('üö´ All tabs inactive - forcing logout');
                            broadcastLogout('all_tabs_inactive');
                        }
                    }
                }, 60000); // Check every minute
            }
            
            // Broadcast logout to all tabs
            function broadcastLogout(reason) {
                localStorage.setItem('logout_all_tabs', JSON.stringify({
                    reason: reason,
                    timestamp: Date.now()
                }));
                
                // Clear the broadcast message after a short delay
                setTimeout(() => {
                    localStorage.removeItem('logout_all_tabs');
                }, 1000);
            }
            
            // Broadcast session extension to all tabs
            function broadcastSessionExtension() {
                localStorage.setItem('session_extended', JSON.stringify({
                    timestamp: Date.now()
                }));
                
                // Clear the broadcast message after a short delay
                setTimeout(() => {
                    localStorage.removeItem('session_extended');
                }, 1000);
            }

            // Add activity listeners to reset dashboard timer
            document.addEventListener('mousemove', resetDashboardTimer);
            document.addEventListener('keydown', resetDashboardTimer);
            document.addEventListener('click', resetDashboardTimer);
            document.addEventListener('scroll', resetDashboardTimer);
            
            // Cross-tab session synchronization
            initCrossTabSessionSync();

            // Initialize dashboard
            if (typeof initDashboard === 'function') {
                initDashboard();
            }

            // Add event listeners for buttons (CSP compliant)
            const editProfileBtn = document.getElementById('editProfileBtn');
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', editProfile);
            }

            const viewSecurityLogsBtn = document.getElementById('viewSecurityLogsBtn');
            if (viewSecurityLogsBtn) {
                viewSecurityLogsBtn.addEventListener('click', viewSecurityLogs);
            }

            const viewAllActivityBtn = document.getElementById('viewAllActivityBtn');
            if (viewAllActivityBtn) {
                viewAllActivityBtn.addEventListener('click', viewAllActivity);
            }

            const downloadLogsBtn = document.getElementById('downloadLogsBtn');
            if (downloadLogsBtn) {
                downloadLogsBtn.addEventListener('click', downloadLogs);
            }

            const exportDataBtn = document.getElementById('exportDataBtn');
            if (exportDataBtn) {
                exportDataBtn.addEventListener('click', exportData);
            }

            const contactSupportBtn = document.getElementById('contactSupportBtn');
            if (contactSupportBtn) {
                contactSupportBtn.addEventListener('click', contactSupport);
            }

            const viewAllSessionsBtn = document.getElementById('viewAllSessionsBtn');
            if (viewAllSessionsBtn) {
                viewAllSessionsBtn.addEventListener('click', viewAllSessions);
            }

            const endOtherSessionsBtn = document.getElementById('endOtherSessionsBtn');
            if (endOtherSessionsBtn) {
                endOtherSessionsBtn.addEventListener('click', endOtherSessions);
            }

            const changePasswordBtn = document.getElementById('changePasswordBtn');
            if (changePasswordBtn) {
                changePasswordBtn.addEventListener('click', changePassword);
            }

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogoutClick);
            }

            // Load current session information
            loadCurrentSessionInfo();
            
            // Test API connectivity first
            testApiConnectivity().then(() => {
                // Load real-time recent activity data
                loadRecentActivity();
            }).catch(error => {
                console.error('API connectivity test failed:', error);
                showActivityLoadError('API connection failed. Please check your login status.');
            });
            
            // Start real-time password expiry tracking
            startPasswordExpiryChecker().catch(error => {
                console.error('Error starting password expiry checker:', error);
            });

            // Start comprehensive notification updates (every 3 minutes)
            setInterval(async () => {
                try {
                    await updateComprehensiveNotifications();
                    console.log('üîî Periodic notification update completed');
                } catch (error) {
                    console.error('Error in periodic notification update:', error);
                }
            }, 180000); // 3 minutes

            // Start real-time activity refresh (every 2 minutes)
            setInterval(async () => {
                try {
                    await loadRecentActivity();
                    console.log('üîÑ Real-time activity refresh completed');
                } catch (error) {
                    console.error('Error in real-time activity refresh:', error);
                }
            }, 120000); // 2 minutes

            // Update last active timestamp every 30 seconds for real-time tracking
            setInterval(async () => {
                try {
                    const token = localStorage.getItem('token');
                    if (token) {
                        await fetch('/api/user/info', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        console.log('‚è±Ô∏è Activity timestamp updated');
                    }
                } catch (error) {
                    console.error('Error updating activity timestamp:', error);
                }
            }, 30000); // 30 seconds
        });

        // Dashboard action functions
        function editProfile() {
            Swal.fire({
                title: 'Edit Profile',
                html: `
                    <div style="text-align: left;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Display Name:</label>
                        <input type="text" id="displayName" class="swal2-input" placeholder="Enter display name">
                        <label style="display: block; margin-bottom: 5px; margin-top: 15px; font-weight: 600;">Bio:</label>
                        <textarea id="bio" class="swal2-textarea" placeholder="Tell us about yourself"></textarea>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Save Changes',
                preConfirm: () => {
                    const displayName = document.getElementById('displayName').value;
                    const bio = document.getElementById('bio').value;
                    return { displayName, bio };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire('Success!', 'Profile updated successfully.', 'success');
                }
            });
        }

        async function viewSecurityLogs() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('No authentication token found. Please log in again.');
                }

                console.log('[Security Logs] Fetching security logs...');
                
                const response = await fetch('/api/user/logs', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('[Security Logs] Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[Security Logs] Error response:', errorText);
                    throw new Error(`Failed to fetch security logs: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('[Security Logs] Response data:', data);
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to fetch security logs');
                }

                // Add null checks and provide fallback data
                const activities = data.activities || [];
                const stats = data.stats || {};
                
                console.log('[Security Logs] Activities found:', activities.length);

                if (!Array.isArray(activities)) {
                    throw new Error('Invalid data structure: activities is not an array');
                }

                const securityEvents = activities.filter(activity => 
                    activity && activity.type && ['failed_login', 'security_alert', 'security_event', 'login', 'password_change'].includes(activity.type)
                );

                let securityHtml = '';
                
                if (securityEvents.length === 0) {
                    securityHtml = '<p style="text-align: center; color: #6b7280; padding: 20px;">No security events found.</p>';
                } else {
                    securityEvents.slice(0, 10).forEach(event => {
                        const timeAgo = getTimeAgo(event.timestamp);
                        const borderColor = getSecurityEventColor(event.type);
                        const backgroundColor = getSecurityEventBg(event.type);
                        
                        securityHtml += `
                            <div style="padding: 10px; border-left: 3px solid ${borderColor}; margin-bottom: 10px; background: ${backgroundColor};">
                                <strong>${event.title}</strong><br>
                                <small>IP: ${event.ipAddress} | ${event.userAgent.substring(0, 50)}... | ${timeAgo}</small><br>
                                <span style="font-size: 0.8rem; color: #6b7280;">${event.description}</span>
                            </div>
                        `;
                    });
                }

                Swal.fire({
                    title: `Security Logs (${securityEvents.length} Events)`,
                    html: `
                        <div style="text-align: left; max-height: 400px; overflow-y: auto;">
                            <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #3b82f6;">
                                <div style="font-size: 14px; color: #1e40af;">
                                    <strong>üîí Security Summary:</strong><br>
                                    Total Events: ${securityEvents.length} | Login Events: ${stats.loginCount || 0}<br>
                                    Security Alerts: ${stats.securityEvents || 0} | Password Changes: ${stats.passwordChanges || 0}
                                </div>
                            </div>
                            ${securityHtml}
                        </div>
                    `,
                    width: 700,
                    confirmButtonText: 'Close'
                });

            } catch (error) {
                console.error('Error fetching security logs:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to load security logs. Please try again.',
                    icon: 'error'
                });
            }
        }

        async function viewAllActivity() {
            try {
                const response = await fetch('/api/user/logs', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch activity logs');
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to fetch activity logs');
                }

                const activities = data.activities || [];
                const stats = data.stats || {};
                
                let activitiesHtml = '';
                
                if (activities.length === 0) {
                    activitiesHtml = '<p style="text-align: center; color: #6b7280; padding: 20px;">No activity history available.</p>';
                } else {
                    activities.forEach((activity, index) => {
                        const timeAgo = getTimeAgo(activity.timestamp);
                        const iconClass = getActivityIcon(activity.type);
                        const bgColor = getActivityColor(activity.type);
                        
                        activitiesHtml += `
                            <div style="padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; background: ${bgColor};">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: ${getActivityIconBg(activity.type)}; display: flex; align-items: center; justify-content: center; color: white;">
                                        <i class="fas fa-${iconClass}"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">${activity.title}</div>
                                        <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 2px;">${activity.description}</div>
                                        <div style="font-size: 0.8rem; color: #9ca3af;">
                                            <span style="margin-right: 15px;"><strong>Time:</strong> ${timeAgo}</span>
                                            <span style="margin-right: 15px;"><strong>IP:</strong> ${activity.ipAddress}</span>
                                            <span><strong>Device:</strong> ${activity.userAgent.substring(0, 50)}...</span>
                                        </div>
                                        <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 4px;">
                                            <strong>Details:</strong> ${activity.details}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 2px;">${activity.status}</div>
                                        <div style="font-size: 0.75rem; color: #9ca3af;">${new Date(activity.timestamp).toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                const last30Days = activities.filter(a => (new Date() - new Date(a.timestamp)) < 30 * 24 * 60 * 60 * 1000).length;
                
                Swal.fire({
                    title: `Complete Activity History (${activities.length} Events)`,
                    html: `
                        <div style="text-align: left; max-height: 500px; overflow-y: auto;">
                            <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #3b82f6;">
                                <div style="font-size: 14px; color: #1e40af;">
                                    <strong>üìä Activity Summary:</strong><br>
                                    Total Events: ${stats.totalActivities || activities.length} | Last 30 Days: ${last30Days}<br>
                                    Logins: ${stats.loginCount || 0} | Security Events: ${stats.securityEvents || 0}<br>
                                    Most Recent: ${activities.length > 0 ? new Date(activities[0].timestamp).toLocaleDateString() : 'None'}
                                </div>
                            </div>
                            ${activitiesHtml}
                        </div>
                    `,
                    width: 900,
                    confirmButtonText: 'Close',
                    showCancelButton: true,
                    cancelButtonText: 'Export Activity',
                    customClass: {
                        htmlContainer: 'custom-swal-container'
                    }
                }).then((result) => {
                    if (result.dismiss === Swal.DismissReason.cancel) {
                        downloadDetailedLogs(activities);
                    }
                });

            } catch (error) {
                console.error('Error fetching activity logs:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to load activity history. Please try again.',
                    icon: 'error'
                });
            }
        }

        function downloadLogs() {
            // Create a mock CSV file
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Date,Activity,IP Address,Browser\n" +
                "2024-01-15,Login Success,192.168.1.100,Chrome\n" +
                "2024-01-14,Profile Update,192.168.1.100,Chrome\n" +
                "2024-01-13,Password Change,192.168.1.100,Chrome\n";
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "activity_logs.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            Swal.fire('Success!', 'Activity logs downloaded successfully.', 'success');
        }

        function exportData() {
            Swal.fire({
                title: 'Export Account Data',
                text: 'This will generate a comprehensive export of your account data including profile information, activity logs, and security events.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Export Data',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire('Processing...', 'Your data export is being prepared. You will receive an email when it\'s ready.', 'info');
                }
            });
        }

        function contactSupport() {
            Swal.fire({
                title: 'Contact Support',
                html: `
                    <div style="text-align: left;">
                        <p style="margin-bottom: 15px;">Need help? Choose how you'd like to contact our support team:</p>
                        <div style="margin-bottom: 10px;">
                            <strong>üìß Email:</strong> support@securesystem.com
                    </div>
                        <div style="margin-bottom: 10px;">
                            <strong>üí¨ Live Chat:</strong> Available 9 AM - 5 PM EST
                    </div>
                        <div style="margin-bottom: 10px;">
                            <strong>üìû Phone:</strong> +1 (555) 123-4567
                    </div>
                        <div style="margin-top: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Quick Message:</label>
                            <textarea id="supportMessage" placeholder="Describe your issue..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                    </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Send Message',
                cancelButtonText: 'Close',
                width: 500
            }).then((result) => {
                if (result.isConfirmed) {
                    const message = document.getElementById('supportMessage').value;
                    if (message.trim()) {
                        Swal.fire('Message Sent!', 'We\'ll get back to you within 24 hours.', 'success');
                } else {
                        Swal.fire('Please enter a message before sending.', '', 'warning');
                    }
                }
            });
        }

        // Load current session information
        function loadCurrentSessionInfo() {
            try {
                // Load user profile information first
                loadUserProfileInfo();
                
                // Detect browser information
                const browser = detectBrowser();
                const os = detectOperatingSystem();
                const deviceType = detectDeviceType();
                
                // Update UI elements
                document.getElementById('currentBrowser').textContent = browser;
                document.getElementById('currentOS').textContent = os;
                document.getElementById('currentDeviceType').textContent = deviceType;
                
                // Set account creation date (simulate account created 6 months ago)
                const accountCreationDate = new Date();
                accountCreationDate.setMonth(accountCreationDate.getMonth() - 6);
                const formattedCreationDate = accountCreationDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Update both account created fields
                document.getElementById('accountCreated').textContent = formattedCreationDate;
                document.getElementById('memberSince').textContent = formattedCreationDate;
                
                // Calculate real-time password expiry based on backend data (async)
                calculateRealPasswordExpiry().then(passwordExpiryInfo => {
                    // Update password expiry information with real data
                    document.getElementById('passwordExpiryDate').textContent = passwordExpiryInfo.formattedExpiryDate;
                    const daysLeftElement = document.getElementById('passwordDaysLeft');
                    daysLeftElement.textContent = passwordExpiryInfo.daysUntilExpiry;
                    
                    // Add dynamic color coding for password expiry warning
                    if (passwordExpiryInfo.daysRemaining <= 7) {
                        daysLeftElement.style.color = '#dc2626';
                        daysLeftElement.style.fontWeight = 'bold';
                        // Add urgent warning class for additional styling
                        daysLeftElement.className = 'password-urgent';
                    } else if (passwordExpiryInfo.daysRemaining <= 14) {
                        daysLeftElement.style.color = '#d97706';
                        daysLeftElement.style.fontWeight = '600';
                        daysLeftElement.className = 'password-warning';
                    } else {
                        daysLeftElement.style.color = '#059669';
                        daysLeftElement.className = 'password-safe';
                    }
                    
                    // Update comprehensive notifications including password expiry
                    updateComprehensiveNotifications();
                    
                    console.log('üîê Password expiry data loaded from backend:', {
                        daysRemaining: passwordExpiryInfo.daysRemaining,
                        expiryDate: passwordExpiryInfo.formattedExpiryDate,
                        changeDate: passwordExpiryInfo.formattedLastChange
                    });
                }).catch(error => {
                    console.error('Error loading password expiry data:', error);
                    
                    // Fallback display
                    document.getElementById('passwordExpiryDate').textContent = 'Loading...';
                    document.getElementById('passwordDaysLeft').textContent = 'Loading...';
                });
                
                // Get session start time from localStorage or current time
                const sessionStart = localStorage.getItem('sessionStartTime') || new Date().toISOString();
                if (!localStorage.getItem('sessionStartTime')) {
                    localStorage.setItem('sessionStartTime', sessionStart);
                }
                document.getElementById('sessionStartTime').textContent = new Date(sessionStart).toLocaleString();
                
                // Set last login time (simulate 2 hours ago)
                const lastLogin = new Date();
                lastLogin.setHours(lastLogin.getHours() - 2);
                document.getElementById('lastLoginTime').textContent = lastLogin.toLocaleString();
                
                // Fetch IP and location information with improved accuracy
                fetchLocationInfo();
                
                // Update security statistics with real data
                updateSecurityStats();
                
            } catch (error) {
                console.error('Error loading session info:', error);
            }
        }

        // Load user profile information
        function loadUserProfileInfo() {
            try {
                // Get stored user info or use default demo data
                const storedUsername = localStorage.getItem('username') || 'demo_user';
                const storedEmail = localStorage.getItem('userEmail') || 'demo.user@securesystem.com';
                
                // Update profile information in UI
                const profileContent = document.getElementById('userProfileContent');
                if (profileContent) {
                    const usernameElement = profileContent.querySelector('.info-item:first-child .info-value');
                    const emailElement = profileContent.querySelector('.info-item:nth-child(2) .info-value');
                    
                    if (usernameElement) usernameElement.textContent = storedUsername;
                    if (emailElement) emailElement.textContent = storedEmail;
                }
                
                // Update welcome message
                const userWelcome = document.getElementById('userWelcome');
                if (userWelcome) {
                    userWelcome.textContent = `Welcome back, ${storedUsername}!`;
                }
                
                console.log('User profile loaded successfully');
                
            } catch (error) {
                console.error('Error loading user profile:', error);
                
                // Fallback to default values
                const usernameElements = document.querySelectorAll('.info-value');
                if (usernameElements.length > 0) {
                    usernameElements[0].textContent = 'demo_user';
                    usernameElements[1].textContent = 'demo.user@securesystem.com';
                }
            }
        }

        // Generate comprehensive user activity data
        function generateUserActivities() {
            const activities = [];
            const now = new Date();
            
            // Generate activities for the last 30 days
            const activityTypes = [
                { type: 'login', title: 'Successful Login', description: 'User logged in successfully' },
                { type: 'logout', title: 'User Logout', description: 'User logged out of the system' },
                { type: 'password_change', title: 'Password Changed', description: 'User changed their password' },
                { type: 'profile_update', title: 'Profile Updated', description: 'User updated profile information' },
                { type: 'failed_login', title: 'Failed Login Attempt', description: 'Unsuccessful login attempt detected' },
                { type: 'security_check', title: 'Security Verification', description: 'Two-factor authentication completed' },
                { type: 'device_login', title: 'New Device Login', description: 'Login from a new device detected' },
                { type: 'session_timeout', title: 'Session Timeout', description: 'Session expired due to inactivity' },
                { type: 'data_export', title: 'Data Export', description: 'User exported account data' },
                { type: 'settings_change', title: 'Settings Modified', description: 'Account settings updated' }
            ];
            
            const devices = ['Desktop Computer', 'Mobile Device', 'Tablet'];
            const browsers = ['Chrome 120.0', 'Firefox 121.0', 'Safari 17.2', 'Edge 119.0'];
            const ipAddresses = ['192.168.1.100', '10.0.0.25', '172.16.1.50', '203.0.113.45'];
            
            // Generate 25 realistic activities
            for (let i = 0; i < 25; i++) {
                const activityTemplate = activityTypes[Math.floor(Math.random() * activityTypes.length)];
                const daysAgo = Math.floor(Math.random() * 30);
                const hoursAgo = Math.floor(Math.random() * 24);
                const minutesAgo = Math.floor(Math.random() * 60);
                
                const timestamp = new Date(now);
                timestamp.setDate(timestamp.getDate() - daysAgo);
                timestamp.setHours(timestamp.getHours() - hoursAgo);
                timestamp.setMinutes(timestamp.getMinutes() - minutesAgo);
                
                activities.push({
                    type: activityTemplate.type,
                    title: activityTemplate.title,
                    description: activityTemplate.description,
                    timestamp: timestamp.toISOString(),
                    ip: ipAddresses[Math.floor(Math.random() * ipAddresses.length)],
                    device: `${devices[Math.floor(Math.random() * devices.length)]} (${browsers[Math.floor(Math.random() * browsers.length)]})`,
                    status: activityTemplate.type === 'failed_login' ? 'FAILED' : 'SUCCESS'
                });
            }
            
            // Sort by timestamp (most recent first)
            return activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }
        
        // Helper function to get time ago format
        function getTimeAgo(timestamp) {
            const now = new Date();
            const activityTime = new Date(timestamp);
            const diffMs = now - activityTime;
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMinutes < 60) {
                return `${diffMinutes} minutes ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hours ago`;
            } else {
                return `${diffDays} days ago`;
            }
        }
        
        // Helper function to get activity icon
        function getActivityIcon(type) {
            const icons = {
                'login': 'sign-in-alt',
                'logout': 'sign-out-alt',
                'password_change': 'key',
                'profile_update': 'user-edit',
                'failed_login': 'exclamation-triangle',
                'security_check': 'shield-alt',
                'device_login': 'mobile-alt',
                'session_timeout': 'clock',
                'data_export': 'download',
                'settings_change': 'cog'
            };
            return icons[type] || 'info-circle';
        }
        
        // Helper function to get activity background color
        function getActivityColor(type) {
            const colors = {
                'login': '#f0fdf4',
                'logout': '#fef3c7',
                'password_change': '#eff6ff',
                'profile_update': '#f0f9ff',
                'failed_login': '#fef2f2',
                'security_check': '#f0fdf4',
                'device_login': '#fef3c7',
                'session_timeout': '#f9fafb',
                'data_export': '#eff6ff',
                'settings_change': '#f9fafb'
            };
            return colors[type] || '#f9fafb';
        }
        
        // Helper function to get activity icon background
        function getActivityIconBg(type) {
            const colors = {
                'login': '#10b981',
                'logout': '#f59e0b',
                'password_change': '#3b82f6',
                'profile_update': '#06b6d4',
                'failed_login': '#ef4444',
                'security_check': '#10b981',
                'device_login': '#f59e0b',
                'session_timeout': '#6b7280',
                'data_export': '#3b82f6',
                'settings_change': '#6b7280'
            };
            return colors[type] || '#6b7280';
        }
        
        // Enhanced download function for detailed activity logs
        function downloadDetailedLogs(activities) {
            if (!activities || activities.length === 0) {
                Swal.fire('No Data', 'No activity data available to download.', 'info');
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Time,Activity Type,Title,Description,Status,IP Address,User Agent,Location,Details\n";
            
            activities.forEach(activity => {
                const date = new Date(activity.timestamp);
                const dateStr = date.toLocaleDateString();
                const timeStr = date.toLocaleTimeString();
                
                csvContent += `"${dateStr}","${timeStr}","${activity.type}","${activity.title}","${activity.description}","${activity.status}","${activity.ipAddress}","${activity.userAgent}","${activity.location}","${activity.details}"\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `detailed_activity_logs_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            Swal.fire('Success!', 'Detailed activity logs downloaded successfully.', 'success');
        }

        // Load real-time recent activity data with improved deduplication
        async function loadRecentActivity() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.warn('[Recent Activity] No authentication token found');
                    showActivityLoadError('Please log in to view activity data');
                    return;
                }

                console.log('[Recent Activity] Fetching real-time activity data...');
                
                const response = await fetch('/api/user/logs', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'X-Session-ID': generateSessionId()
                    }
                });

                console.log('[Recent Activity] Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[Recent Activity] Error response:', errorText);
                    throw new Error(`Failed to fetch activity data: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('[Recent Activity] Real-time response data:', data);
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to fetch activity data');
                }

                const activities = data.activities || [];
                const realTimeData = data.realTimeData || {};
                
                if (!Array.isArray(activities)) {
                    throw new Error('Invalid data structure: activities is not an array');
                }

                console.log('[Recent Activity] Activities found:', activities.length);
                console.log('[Recent Activity] Real-time data:', realTimeData);

                const recentActivities = activities.slice(0, 4); // Show only the 4 most recent
                const container = document.getElementById('recentActivityContainer');
                
                if (!container) return;

                // Clear loading indicator
                container.innerHTML = '';

                if (recentActivities.length === 0) {
                    container.innerHTML = `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-info-circle" aria-hidden="true"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">No recent activity</div>
                                <div class="activity-time">Activity will appear here as you use the system</div>
                            </div>
                        </div>
                    `;
                    return;
                }

                // Populate with clean, unique activity data
                recentActivities.forEach(activity => {
                    const timeAgo = getTimeAgo(activity.timestamp);
                    const iconClass = getActivityIcon(activity.type);
                    const iconType = getActivityIconType(activity.type);
                    
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';
                    
                    activityItem.innerHTML = `
                        <div class="activity-icon ${iconType}">
                            <i class="fas fa-${iconClass}" aria-hidden="true"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    `;
                    
                    container.appendChild(activityItem);
                });

                // Update real-time session information in UI
                if (realTimeData.sessionDuration !== undefined) {
                    console.log(`‚è±Ô∏è Session duration: ${realTimeData.sessionDuration} minutes`);
                }

                console.log('‚úÖ Real-time activity loaded successfully:', recentActivities.length, 'items');

            } catch (error) {
                console.error('Error loading recent activity:', error);
                showActivityLoadError(error.message);
            }
        }

        // Helper function to show activity load errors
        function showActivityLoadError(message) {
            const container = document.getElementById('recentActivityContainer');
            if (container) {
                container.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Failed to load activity</div>
                            <div class="activity-time">${message || 'Please try refreshing the page'}</div>
                        </div>
                    </div>
                `;
            }
        }

        // Test API connectivity and authentication
        async function testApiConnectivity() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('No authentication token found');
                }

                console.log('[API Test] Testing API connectivity...');
                
                const response = await fetch('/api/user/test', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('[API Test] Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[API Test] Error response:', errorText);
                    throw new Error(`API test failed: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('[API Test] API connectivity successful:', data);
                
                if (!data.success) {
                    throw new Error(data.message || 'API test returned failure');
                }

                return data;
            } catch (error) {
                console.error('[API Test] API connectivity test failed:', error);
                throw error;
            }
        }

        // Helper function to get activity icon type for CSS classes
        function getActivityIconType(type) {
            const iconTypes = {
                'login': 'login',
                'logout': 'logout',
                'password_change': 'security',
                'account_creation': 'security',
                'profile_update': 'update',
                'failed_login': 'security',
                'security_check': 'security',
                'device_login': 'login',
                'session_timeout': 'logout',
                'data_export': 'update',
                'settings_change': 'update',
                'security_alert': 'security',
                'security_event': 'security',
                'current_session': 'login'
            };
            return iconTypes[type] || 'update';
        }

        // Helper function to get security event colors
        function getSecurityEventColor(type) {
            const colors = {
                'login': '#10b981',
                'logout': '#f59e0b',
                'password_change': '#3b82f6',
                'failed_login': '#ef4444',
                'security_alert': '#ef4444',
                'security_event': '#6b7280'
            };
            return colors[type] || '#6b7280';
        }

        // Helper function to get security event background colors
        function getSecurityEventBg(type) {
            const colors = {
                'login': '#f0fdf4',
                'logout': '#fef3c7',
                'password_change': '#eff6ff',
                'failed_login': '#fef2f2',
                'security_alert': '#fef2f2',
                'security_event': '#f9fafb'
            };
            return colors[type] || '#f9fafb';
        }

        // Detect browser information
        function detectBrowser() {
            const userAgent = navigator.userAgent;
            
            if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) {
                return 'Google Chrome ' + userAgent.match(/Chrome\/([0-9.]+)/)[1];
            } else if (userAgent.includes('Firefox')) {
                return 'Mozilla Firefox ' + userAgent.match(/Firefox\/([0-9.]+)/)[1];
            } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
                return 'Safari ' + userAgent.match(/Version\/([0-9.]+)/)[1];
            } else if (userAgent.includes('Edg')) {
                return 'Microsoft Edge ' + userAgent.match(/Edg\/([0-9.]+)/)[1];
            } else if (userAgent.includes('Opera')) {
                return 'Opera ' + userAgent.match(/Opera\/([0-9.]+)/)[1];
            } else {
                return 'Unknown Browser';
            }
        }

        // Detect operating system
        function detectOperatingSystem() {
            const userAgent = navigator.userAgent;
            
            if (userAgent.includes('Windows NT 10.0')) {
                return 'Windows 10/11';
            } else if (userAgent.includes('Windows NT 6.3')) {
                return 'Windows 8.1';
            } else if (userAgent.includes('Windows NT 6.2')) {
                return 'Windows 8';
            } else if (userAgent.includes('Windows NT 6.1')) {
                return 'Windows 7';
            } else if (userAgent.includes('Mac OS X')) {
                return 'macOS ' + userAgent.match(/Mac OS X ([0-9_]+)/)[1].replace(/_/g, '.');
            } else if (userAgent.includes('Linux')) {
                return 'Linux';
            } else if (userAgent.includes('Android')) {
                return 'Android ' + userAgent.match(/Android ([0-9.]+)/)[1];
            } else if (userAgent.includes('iPhone') || userAgent.includes('iPad')) {
                return 'iOS ' + userAgent.match(/OS ([0-9_]+)/)[1].replace(/_/g, '.');
                            } else {
                return 'Unknown OS';
            }
        }

        // Detect device type
        function detectDeviceType() {
            const userAgent = navigator.userAgent;
            
            if (userAgent.includes('Mobile') || userAgent.includes('Android')) {
                return 'Mobile Device';
            } else if (userAgent.includes('Tablet') || userAgent.includes('iPad')) {
                return 'Tablet';
            } else {
                return 'Desktop Computer';
            }
        }

        // Get location and IP information using browser APIs and simulate server data
        function fetchLocationInfo() {
            try {
                // Generate realistic IP for demo (in real app, get from server)
                const simulatedIP = generateRealisticIP();
                document.getElementById('currentIP').textContent = simulatedIP;
                
                // Immediately set timezone-based location as fallback
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const fallbackLocation = getLocationFromTimezone(timezone);
                document.getElementById('currentLocation').textContent = fallbackLocation;
                
                // Try to get more precise location using browser geolocation API
                if (navigator.geolocation) {
                    // Set a timeout to prevent endless loading
                    const geoTimeout = setTimeout(() => {
                        console.log('Geolocation timeout, using timezone fallback');
                    }, 3000);
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            clearTimeout(geoTimeout);
                            // Use coordinates to get approximate location
                            const lat = position.coords.latitude.toFixed(2);
                            const lon = position.coords.longitude.toFixed(2);
                            
                            // Try to get city name from coordinates (simplified mapping)
                            const approximateLocation = getLocationFromCoordinates(lat, lon);
                            if (approximateLocation) {
                                document.getElementById('currentLocation').textContent = approximateLocation;
                            } else {
                                // Keep the timezone-based location with coordinates
                                document.getElementById('currentLocation').textContent = `${fallbackLocation} (${lat}¬∞, ${lon}¬∞)`;
                            }
                        },
                        (error) => {
                            clearTimeout(geoTimeout);
                            console.log('Geolocation error:', error.message);
                            // Location already set to timezone fallback, no need to change
                            
                            // Add more specific location info based on timezone and language
                            const enhancedLocation = getEnhancedLocationInfo();
                            document.getElementById('currentLocation').textContent = enhancedLocation;
                        },
                        { 
                            timeout: 5000, 
                            enableHighAccuracy: false,
                            maximumAge: 300000 // 5 minutes cache
                        }
                    );
                } else {
                    // Geolocation not supported, enhance the fallback location
                    const enhancedLocation = getEnhancedLocationInfo();
                    document.getElementById('currentLocation').textContent = enhancedLocation;
                }
                
                // Store device information for tracking
                storeDeviceSession();
                
            } catch (error) {
                console.error('Error fetching location:', error);
                document.getElementById('currentIP').textContent = 'Private Network';
                
                // Even on error, provide some location info
                const basicLocation = getEnhancedLocationInfo();
                document.getElementById('currentLocation').textContent = basicLocation;
            }
        }
        
        // Enhanced location detection using multiple browser APIs
        function getEnhancedLocationInfo() {
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const language = navigator.language || navigator.userLanguage;
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            
            // Get base location from timezone
            let location = getLocationFromTimezone(timezone);
            
            // Enhance with language/locale information
            if (language.startsWith('en-US')) {
                if (timezone.includes('New_York')) location = 'New York, NY, United States';
                else if (timezone.includes('Los_Angeles')) location = 'Los Angeles, CA, United States';
                else if (timezone.includes('Chicago')) location = 'Chicago, IL, United States';
            } else if (language.startsWith('en-GB')) {
                location = 'London, United Kingdom';
            } else if (language.startsWith('fr')) {
                location = 'Paris, France';
            } else if (language.startsWith('de')) {
                location = 'Berlin, Germany';
            } else if (language.startsWith('es')) {
                location = 'Madrid, Spain';
            } else if (language.startsWith('it')) {
                location = 'Rome, Italy';
            } else if (language.startsWith('ja')) {
                location = 'Tokyo, Japan';
            } else if (language.startsWith('ko')) {
                location = 'Seoul, South Korea';
            } else if (language.startsWith('zh')) {
                location = 'Beijing, China';
            } else if (language.startsWith('ru')) {
                location = 'Moscow, Russia';
            } else if (language.startsWith('pt')) {
                location = 'S√£o Paulo, Brazil';
            } else if (language.startsWith('ar')) {
                location = 'Dubai, UAE';
            } else if (language.startsWith('hi')) {
                location = 'Mumbai, India';
            }
            
            // Add connection type if available
            if (connection && connection.effectiveType) {
                location += ` (${connection.effectiveType.toUpperCase()} Connection)`;
            }
            
            return location;
        }
        
        // Simple coordinate to location mapping (for demo purposes)
        function getLocationFromCoordinates(lat, lon) {
            const latitude = parseFloat(lat);
            const longitude = parseFloat(lon);
            
            // Simple mapping for major cities (this would be much more comprehensive in a real app)
            const cityMappings = [
                { lat: 40.7, lon: -74.0, city: 'New York, NY, United States' },
                { lat: 34.1, lon: -118.2, city: 'Los Angeles, CA, United States' },
                { lat: 51.5, lon: -0.1, city: 'London, United Kingdom' },
                { lat: 48.9, lon: 2.3, city: 'Paris, France' },
                { lat: 35.7, lon: 139.7, city: 'Tokyo, Japan' },
                { lat: 37.6, lon: 126.9, city: 'Seoul, South Korea' },
                { lat: 52.5, lon: 13.4, city: 'Berlin, Germany' },
                { lat: 40.4, lon: -3.7, city: 'Madrid, Spain' },
                { lat: 41.9, lon: 12.5, city: 'Rome, Italy' },
                { lat: 19.1, lon: 72.9, city: 'Mumbai, India' }
            ];
            
            // Find closest city (within 2 degrees)
            for (const mapping of cityMappings) {
                const latDiff = Math.abs(latitude - mapping.lat);
                const lonDiff = Math.abs(longitude - mapping.lon);
                
                if (latDiff < 2 && lonDiff < 2) {
                    return mapping.city;
                }
            }
            
            return null; // No close match found
        }

        // Generate realistic IP address for demo
        function generateRealisticIP() {
            // Common IP ranges for demonstration
            const ranges = [
                '192.168.1.',
                '10.0.0.',
                '172.16.1.',
                '203.0.113.',
                '198.51.100.'
            ];
            const range = ranges[Math.floor(Math.random() * ranges.length)];
            const lastOctet = Math.floor(Math.random() * 254) + 1;
            return range + lastOctet;
        }

        // Get approximate location from timezone
        function getLocationFromTimezone(timezone) {
            const locations = {
                'America/New_York': 'New York, NY, United States',
                'America/Los_Angeles': 'Los Angeles, CA, United States',
                'America/Chicago': 'Chicago, IL, United States',
                'Europe/London': 'London, United Kingdom',
                'Europe/Paris': 'Paris, France',
                'Europe/Berlin': 'Berlin, Germany',
                'Asia/Tokyo': 'Tokyo, Japan',
                'Asia/Shanghai': 'Shanghai, China',
                'Asia/Kolkata': 'Mumbai, India',
                'Australia/Sydney': 'Sydney, Australia',
                'America/Toronto': 'Toronto, Canada',
                'Europe/Rome': 'Rome, Italy',
                'Asia/Seoul': 'Seoul, South Korea'
            };
            
            return locations[timezone] || timezone.replace(/_/g, ' ');
        }

        // Store current device session with deduplication
        function storeDeviceSession() {
            const currentSession = {
                id: generateSessionId(),
                browser: document.getElementById('currentBrowser').textContent,
                os: document.getElementById('currentOS').textContent,
                deviceType: document.getElementById('currentDeviceType').textContent,
                ip: document.getElementById('currentIP').textContent,
                location: document.getElementById('currentLocation').textContent,
                loginTime: new Date().toISOString(),
                isActive: true,
                userAgent: navigator.userAgent
            };

            // Get existing sessions
            const existingSessions = JSON.parse(localStorage.getItem('deviceSessions') || '[]');
            
            // Create unique device fingerprint for comparison
            const deviceFingerprint = `${currentSession.browser}_${currentSession.os}_${currentSession.deviceType}`;
            
            // Check if this exact session already exists today
            const today = new Date().toISOString().split('T')[0];
            const existingTodaySession = existingSessions.find(session => 
                session.browser === currentSession.browser && 
                session.os === currentSession.os &&
                session.deviceType === currentSession.deviceType &&
                session.loginTime.startsWith(today)
            );

            // Only add if no session exists for this device today
            if (!existingTodaySession) {
                // Check if this is a completely new device
                const isNewDevice = !existingSessions.some(session => 
                    session.browser === currentSession.browser && 
                    session.os === currentSession.os &&
                    session.deviceType === currentSession.deviceType
                );

                // Add current session
                existingSessions.push(currentSession);
                
                // Keep only last 20 sessions for better history
                if (existingSessions.length > 20) {
                    existingSessions.splice(0, existingSessions.length - 20);
                }
                
                localStorage.setItem('deviceSessions', JSON.stringify(existingSessions));
                
                // Send email notification for new device login
                if (isNewDevice) {
                    sendNewDeviceLoginEmail(currentSession);
                }
                
                console.log('üì± Device session stored:', {
                    device: deviceFingerprint,
                    isNewDevice: isNewDevice,
                    totalSessions: existingSessions.length
                });
            } else {
                console.log('üì± Device session already exists for today, skipping duplicate');
            }
            
            // Always update device count in UI
            updateDeviceCount();
        }

        // Generate unique session ID
        function generateSessionId() {
            return 'sess_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }

        // Simulate email notification for new device login
        function sendNewDeviceLoginEmail(session) {
            // In a real application, this would call your backend API
            console.log('üîî New Device Login Email Sent');
            
            // Show notification to user
            setTimeout(() => {
                Swal.fire({
                    title: 'üîî Security Alert',
                    html: `
                        <div style="text-align: left;">
                            <p style="margin-bottom: 15px;"><strong>New device login detected:</strong></p>
                            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #0ea5e9;">
                                <div style="margin-bottom: 8px;"><strong>Device:</strong> ${session.deviceType}</div>
                                <div style="margin-bottom: 8px;"><strong>Browser:</strong> ${session.browser}</div>
                                <div style="margin-bottom: 8px;"><strong>OS:</strong> ${session.os}</div>
                                <div style="margin-bottom: 8px;"><strong>Location:</strong> ${session.location}</div>
                                <div style="margin-bottom: 8px;"><strong>IP:</strong> ${session.ip}</div>
                                <div><strong>Time:</strong> ${new Date(session.loginTime).toLocaleString()}</div>
                        </div>
                            <p style="color: #059669; font-weight: 600;">‚úÖ Security email notification sent to your registered email address.</p>
                            <p style="color: #6b7280; font-size: 14px;">If this wasn't you, please change your password immediately and review your account security.</p>
                                </div>
                            `,
                    icon: 'info',
                    width: 600,
                    confirmButtonText: 'Understood'
                });
            }, 2000);
        }

        // Update device count in the UI
        function updateDeviceCount() {
            const sessions = JSON.parse(localStorage.getItem('deviceSessions') || '[]');
            const uniqueDevices = getUniqueDevices(sessions);
            
            // Update stats in security overview
            const securityOverview = document.querySelector('.card-title').closest('.dashboard-card');
            if (securityOverview) {
                const statsGrid = securityOverview.querySelector('.stats-grid');
                if (statsGrid) {
                    // Update device count stat
                    const statItems = statsGrid.querySelectorAll('.stat-item');
                    if (statItems.length > 3) {
                        statItems[3].querySelector('.stat-number').textContent = uniqueDevices.length;
                        statItems[3].querySelector('.stat-label').textContent = 'Devices Used';
                    }
                }
            }
        }

        // Get unique devices from sessions
        function getUniqueDevices(sessions) {
            const unique = [];
            const seen = new Set();
            
            sessions.forEach(session => {
                const deviceKey = `${session.deviceType}-${session.browser}-${session.os}`;
                if (!seen.has(deviceKey)) {
                    seen.add(deviceKey);
                    unique.push(session);
                }
            });
            
            return unique;
        }

        // Load device information from backend (Google-like)
        async function loadDeviceInformation() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('No authentication token found');
                }

                console.log('[Device Management] Fetching device information...');
                
                const response = await fetch('/api/user/devices', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch device information: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to fetch device information');
                }

                console.log('[Device Management] Device data loaded:', data);
                
                return data;

            } catch (error) {
                console.error('Error loading device information:', error);
                throw error;
            }
        }

        // Revoke device access
        async function revokeDeviceAccess(deviceId, deviceName) {
            try {
                const result = await Swal.fire({
                    title: 'Revoke Device Access?',
                    html: `
                        <div style="text-align: left;">
                            <p>Are you sure you want to revoke access for:</p>
                            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #f59e0b;">
                                <strong>${deviceName}</strong>
                            </div>
                            <p style="color: #dc2626; font-weight: 600;">This device will be signed out immediately and won't be able to access your account.</p>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Revoke Access',
                    confirmButtonColor: '#dc2626',
                    cancelButtonText: 'Cancel'
                });

                if (!result.isConfirmed) return;

                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('No authentication token found');
                }

                console.log('[Device Management] Revoking device access:', deviceId);
                
                const response = await fetch(`/api/user/devices/${deviceId}/revoke`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to revoke device access: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to revoke device access');
                }

                Swal.fire({
                    title: 'Device Access Revoked',
                    text: `${deviceName} has been signed out successfully.`,
                    icon: 'success',
                    timer: 3000
                });

                // Refresh device list
                showDeviceManagement();

            } catch (error) {
                console.error('Error revoking device access:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to revoke device access. Please try again.',
                    icon: 'error'
                });
            }
        }

        // View all active sessions (Google-like device management)
        async function viewAllSessions() {
            try {
                const deviceData = await loadDeviceInformation();
                const devices = deviceData.devices || [];
                const summary = deviceData.summary || {};
                
                if (devices.length === 0) {
                    Swal.fire({
                        title: 'No Devices Found',
                        text: 'No device history available.',
                        icon: 'info'
                    });
                    return;
                }

                let devicesHtml = '';
                
                devices.forEach((device, index) => {
                    const isActive = device.isActive;
                    const statusColor = isActive ? '#10b981' : '#6b7280';
                    const statusText = isActive ? 'ACTIVE NOW' : 'INACTIVE';
                    const borderColor = isActive ? '#10b981' : '#d1d5db';
                    const backgroundColor = isActive ? '#f0fdf4' : '#f9fafb';
                    
                    devicesHtml += `
                        <div style="padding: 15px; border: 2px solid ${borderColor}; border-radius: 12px; margin-bottom: 15px; background: ${backgroundColor};">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center;">
                                    <i class="fas fa-${getDeviceIcon(device.deviceType)}" style="color: ${statusColor}; margin-right: 12px; font-size: 24px;"></i>
                                    <div>
                                        <div style="font-weight: 600; color: #374151; font-size: 16px;">${device.deviceName}</div>
                                        <div style="color: #6b7280; font-size: 14px;">${device.browser} ‚Ä¢ ${device.os}</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;">${statusText}</span>
                                    ${device.id !== 'current_session' && !isActive ? 
                                        `<button onclick="revokeDeviceAccess('${device.id}', '${device.deviceName}')" style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; font-weight: 500;">Revoke</button>` : 
                                        device.id === 'current_session' ? 
                                        '<span style="color: #10b981; font-size: 12px; font-weight: 600;">This Device</span>' : ''
                                    }
                                </div>
                            </div>
                            <div style="grid-template-columns: repeat(2, 1fr); gap: 12px; display: grid; font-size: 13px; color: #6b7280;">
                                <div><strong>IP Address:</strong> ${device.ipAddress}</div>
                                <div><strong>Location:</strong> ${device.location}</div>
                                <div><strong>First Seen:</strong> ${new Date(device.firstSeen).toLocaleDateString()}</div>
                                <div><strong>Last Seen:</strong> ${new Date(device.lastSeen).toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                });
                
                Swal.fire({
                    title: `Device Security (${summary.totalDevices} Devices)`,
                    html: `
                        <div style="text-align: left; max-height: 500px; overflow-y: auto;">
                            <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                                <div style="font-size: 14px; color: #1e40af; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                    <div><strong>Total Devices:</strong><br>${summary.totalDevices}</div>
                                    <div><strong>Active Now:</strong><br><span style="color: #10b981;">${summary.activeDevices}</span></div>
                                    <div><strong>Inactive:</strong><br><span style="color: #6b7280;">${summary.inactiveDevices}</span></div>
                                </div>
                            </div>
                            ${devicesHtml}
                        </div>
                    `,
                    width: 800,
                    confirmButtonText: 'Close',
                    showCancelButton: true,
                    cancelButtonText: 'Security Settings',
                    customClass: {
                        htmlContainer: 'custom-swal-container'
                    }
                }).then((result) => {
                    if (result.dismiss === Swal.DismissReason.cancel) {
                        showDeviceManagement();
                    }
                });

            } catch (error) {
                console.error('Error loading device sessions:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to load device information. Please try again.',
                    icon: 'error'
                });
            }
        }

        // Get device icon based on device type
        function getDeviceIcon(deviceType) {
            switch (deviceType.toLowerCase()) {
                case 'mobile device':
                case 'mobile':
                    return 'mobile-alt';
                case 'tablet':
                    return 'tablet-alt';
                case 'desktop computer':
                case 'desktop':
                default:
                    return 'desktop';
            }
        }

        // Show device management interface
        function showDeviceManagement() {
            const sessions = JSON.parse(localStorage.getItem('deviceSessions') || '[]');
            const uniqueDevices = getUniqueDevices(sessions);
            
            let devicesHtml = '';
            
            uniqueDevices.forEach((device, index) => {
                const relatedSessions = sessions.filter(s => 
                    s.browser === device.browser && 
                    s.os === device.os && 
                    s.deviceType === device.deviceType
                );
                
                const lastUsed = new Date(Math.max(...relatedSessions.map(s => new Date(s.loginTime))));
                const isCurrent = device.id === sessions[sessions.length - 1]?.id;
                
                devicesHtml += `
                    <div style="padding: 15px; border: 1px solid ${isCurrent ? '#10b981' : '#d1d5db'}; border-radius: 8px; margin-bottom: 15px; background: ${isCurrent ? '#f0fdf4' : '#ffffff'};">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-${getDeviceIcon(device.deviceType)}" style="color: ${isCurrent ? '#10b981' : '#6b7280'}; margin-right: 10px; font-size: 20px;"></i>
                                <div>
                                    <div style="font-weight: 600; color: #374151;">${device.deviceType}</div>
                                    <div style="font-size: 12px; color: #6b7280;">${device.browser} on ${device.os}</div>
                                </div>
                            </div>
                            ${isCurrent ? 
                                '<span style="background: #10b981; color: white; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;">CURRENT</span>' :
                                `<button onclick="removeDevice('${device.id}')" style="background: #ef4444; color: white; border: none; padding: 4px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">Remove</button>`
                            }
                        </div>
                        <div style="font-size: 13px; color: #6b7280;">
                            <div><strong>Location:</strong> ${device.location}</div>
                            <div><strong>Last IP:</strong> ${device.ip}</div>
                            <div><strong>Last Used:</strong> ${lastUsed.toLocaleString()}</div>
                            <div><strong>Sessions:</strong> ${relatedSessions.length} login${relatedSessions.length !== 1 ? 's' : ''}</div>
                        </div>
                    </div>
                `;
            });
            
            Swal.fire({
                title: 'Device Management',
                html: `
                    <div style="text-align: left; max-height: 400px; overflow-y: auto;">
                        <div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #f59e0b;">
                            <div style="font-size: 14px; color: #92400e;">
                                <strong>‚ö†Ô∏è Security Tip:</strong> Remove devices you no longer use or don't recognize.
                            </div>
                        </div>
                        ${devicesHtml || '<p style="text-align: center; color: #6b7280; padding: 20px;">No devices found.</p>'}
                    </div>
                `,
                width: 600,
                confirmButtonText: 'Done',
                showCancelButton: true,
                cancelButtonText: 'Clear All History'
            }).then((result) => {
                if (result.dismiss === Swal.DismissReason.cancel) {
                    clearDeviceHistory();
                }
            });
        }

        // Remove specific device from history
        window.removeDevice = function(deviceId) {
            Swal.fire({
                title: 'Remove Device?',
                text: 'This will remove this device from your login history.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Remove',
                confirmButtonColor: '#ef4444'
            }).then((result) => {
                if (result.isConfirmed) {
                    let sessions = JSON.parse(localStorage.getItem('deviceSessions') || '[]');
                    sessions = sessions.filter(s => s.id !== deviceId);
                    localStorage.setItem('deviceSessions', JSON.stringify(sessions));
                    
                    Swal.fire('Removed!', 'Device has been removed from your history.', 'success');
                    updateDeviceCount();
                }
            });
        }

        // Clear all device history
        function clearDeviceHistory() {
            Swal.fire({
                title: 'Clear All History?',
                text: 'This will remove all device login history except your current session.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Clear History',
                confirmButtonColor: '#ef4444'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Keep only current session
                    const currentSession = JSON.parse(localStorage.getItem('deviceSessions') || '[]').slice(-1);
                    localStorage.setItem('deviceSessions', JSON.stringify(currentSession));
                    
                    Swal.fire('Cleared!', 'All device history has been cleared.', 'success');
                    updateDeviceCount();
                }
            });
        }

        // End other active sessions with backend API call
        async function endOtherSessions() {
            try {
                const result = await Swal.fire({
                    title: 'üîê End Other Sessions',
                    html: `
                        <div style="text-align: left;">
                            <p style="margin-bottom: 15px;">This will immediately sign out all your other devices and sessions.</p>
                            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #f59e0b;">
                                <strong>‚ö†Ô∏è Warning:</strong>
                                <ul style="margin: 8px 0 0 20px; color: #92400e;">
                                    <li>All other devices will be signed out immediately</li>
                                    <li>You'll need to log in again on those devices</li>
                                    <li>Your current session will remain active</li>
                                </ul>
                            </div>
                            <p style="color: #dc2626; font-weight: 600;">Are you sure you want to continue?</p>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, End All Other Sessions',
                    confirmButtonColor: '#dc2626',
                    cancelButtonText: 'Cancel',
                    width: 600
                });

                if (!result.isConfirmed) return;

                // Show loading state
                Swal.fire({
                    title: 'Ending Other Sessions...',
                    text: 'Please wait while we sign out your other devices.',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('No authentication token found');
                }

                console.log('[End Sessions] Terminating other sessions...');
                
                const response = await fetch('/api/user/sessions/end-others', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'X-Session-ID': generateSessionId()
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[End Sessions] Error response:', errorText);
                    throw new Error(`Failed to end other sessions: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to end other sessions');
                }

                console.log('[End Sessions] Other sessions ended successfully:', data);

                // Show success message
                Swal.fire({
                    title: '‚úÖ Sessions Terminated',
                    html: `
                        <div style="text-align: left;">
                            <p style="margin-bottom: 15px;"><strong>All other sessions have been terminated successfully!</strong></p>
                            <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #10b981;">
                                <div style="color: #059669;">
                                    <strong>‚úÖ Security Actions Completed:</strong>
                                    <ul style="margin: 8px 0 0 20px;">
                                        <li>Revoked sessions: ${data.revokedSessions || 'All others'}</li>
                                        <li>JWT tokens invalidated</li>
                                        <li>All other devices signed out</li>
                                        <li>Your current session remains active</li>
                                    </ul>
                                </div>
                            </div>
                            <p style="color: #6b7280; font-size: 14px;">You can now safely continue using your account. Other devices will need to log in again.</p>
                        </div>
                    `,
                    icon: 'success',
                    confirmButtonText: 'Perfect!',
                    timer: 8000,
                    width: 600
                });

                // Refresh device management to show updated status
                setTimeout(async () => {
                    try {
                        if (typeof loadDeviceInformation === 'function') {
                            await loadDeviceInformation();
                        }
                    } catch (error) {
                        console.log('Note: Device information refresh skipped');
                    }
                }, 1000);

            } catch (error) {
                console.error('[End Sessions] Error ending other sessions:', error);
                Swal.fire({
                    title: 'Error',
                    html: `
                        <div style="text-align: left;">
                            <p>Failed to end other sessions:</p>
                            <div style="background: #fef2f2; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ef4444;">
                                <code style="color: #dc2626;">${error.message}</code>
                            </div>
                            <p style="color: #6b7280; font-size: 14px;">Please try again or contact support if the problem persists.</p>
                        </div>
                    `,
                    icon: 'error',
                    width: 500
                });
            }
        }

        // Update security stats with real data
        function updateSecurityStats() {
            const sessions = JSON.parse(localStorage.getItem('deviceSessions') || '[]');
            const uniqueDevices = getUniqueDevices(sessions);
            
            // Calculate security metrics
            const totalLogins = sessions.length;
            const failedAttempts = Math.floor(totalLogins * 0.1); // Simulate 10% failed rate
            const successRate = ((totalLogins - failedAttempts) / totalLogins * 100).toFixed(1);
            const securityScore = Math.min(98, 85 + (uniqueDevices.length > 3 ? 0 : 5) + (failedAttempts < 3 ? 8 : 0));
            
            // Update the security overview stats
            setTimeout(() => {
                const securityCards = document.querySelectorAll('.dashboard-card');
                let securityCard = null;
                
                securityCards.forEach(card => {
                    const title = card.querySelector('.card-title');
                    if (title && title.textContent.includes('Security Overview')) {
                        securityCard = card;
                    }
                });
                
                if (securityCard) {
                    const statItems = securityCard.querySelectorAll('.stat-item');
                    if (statItems.length >= 4) {
                        statItems[0].querySelector('.stat-number').textContent = totalLogins;
                        statItems[0].querySelector('.stat-label').textContent = 'Total Logins';
                        
                        statItems[1].querySelector('.stat-number').textContent = failedAttempts;
                        statItems[1].querySelector('.stat-label').textContent = 'Failed Attempts';
                        
                        statItems[2].querySelector('.stat-number').textContent = sessions.length > 0 ? '1h' : '24h';
                        statItems[2].querySelector('.stat-label').textContent = 'Last Login';
                        
                        statItems[3].querySelector('.stat-number').textContent = securityScore + '%';
                        statItems[3].querySelector('.stat-label').textContent = 'Security Score';
                    }
                }
            }, 500);
        }

        // Get real-time password expiry data from backend
        async function fetchRealPasswordData() {
            try {
                console.log('üîê Fetching real password data from backend...');
                
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('No authentication token found');
                }

                const response = await fetch('/api/user/info', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to fetch user data');
                }

                const user = data.user;
                console.log('üîê Real password data fetched:', user);

                return {
                    passwordCreatedAt: user.passwordCreatedAt,
                    passwordExpiresAt: user.passwordExpiresAt,
                    daysUntilExpiry: user.daysUntilExpiry,
                    isPasswordExpired: user.isPasswordExpired,
                    isPasswordExpiringSoon: user.isPasswordExpiringSoon,
                    userData: user
                };

            } catch (error) {
                console.error('Error fetching real password data:', error);
                
                // Fallback to safe default
                return {
                    passwordCreatedAt: new Date().toISOString(),
                    passwordExpiresAt: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString(),
                    daysUntilExpiry: 15,
                    isPasswordExpired: false,
                    isPasswordExpiringSoon: false,
                    userData: null
                };
            }
        }

        // Calculate real-time password expiry based on backend data
        async function calculateRealPasswordExpiry() {
            try {
                // Fetch real data from backend
                const realData = await fetchRealPasswordData();
                
                const passwordCreatedAt = new Date(realData.passwordCreatedAt);
                const passwordExpiresAt = new Date(realData.passwordExpiresAt);
                const now = new Date();
                
                // Calculate days remaining (real-time calculation)
                const timeUntilExpiry = passwordExpiresAt.getTime() - now.getTime();
                const daysRemaining = Math.ceil(timeUntilExpiry / (1000 * 60 * 60 * 24));
                
                // Format dates for display
                const formattedExpiryDate = passwordExpiresAt.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const formattedLastChange = passwordCreatedAt.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Create dynamic display text based on urgency
                let daysUntilExpiryText;
                if (daysRemaining <= 0) {
                    daysUntilExpiryText = "‚ö†Ô∏è EXPIRED - Change Now!";
                } else if (daysRemaining === 1) {
                    daysUntilExpiryText = "‚ö†Ô∏è 1 day (Tomorrow!)";
                } else if (daysRemaining <= 7) {
                    daysUntilExpiryText = `‚ö†Ô∏è ${daysRemaining} days (Urgent!)`;
                } else if (daysRemaining <= 14) {
                    daysUntilExpiryText = `‚ö†Ô∏è ${daysRemaining} days (Soon)`;
                } else {
                    daysUntilExpiryText = `‚úÖ ${daysRemaining} days`;
                }
                
                console.log('üîê Password expiry calculated from real backend data:', {
                    passwordCreatedAt: formattedLastChange,
                    passwordExpiresAt: formattedExpiryDate,
                    daysRemaining: daysRemaining,
                    status: daysRemaining <= 0 ? 'EXPIRED' : daysRemaining <= 7 ? 'URGENT' : daysRemaining <= 14 ? 'WARNING' : 'SAFE'
                });
                
                return {
                    daysRemaining,
                    daysUntilExpiry: daysUntilExpiryText,
                    formattedExpiryDate,
                    formattedLastChange,
                    isExpired: daysRemaining <= 0,
                    isUrgent: daysRemaining <= 7,
                    isWarning: daysRemaining <= 14,
                    expiryDate: passwordExpiresAt,
                    lastChangeDate: passwordCreatedAt,
                    userData: realData.userData
                };
                
            } catch (error) {
                console.error('Error calculating password expiry:', error);
                
                // Fallback to safe default
                return {
                    daysRemaining: 15,
                    daysUntilExpiry: "15 days",
                    formattedExpiryDate: "Unknown",
                    formattedLastChange: "Unknown",
                    isExpired: false,
                    isUrgent: false,
                    isWarning: false
                };
            }
        }
        
        // Update comprehensive notifications based on backend data
        async function updateComprehensiveNotifications() {
            try {
                console.log('üîî Updating comprehensive notifications...');
                
                const notificationBadge = document.getElementById('notificationBadge');
                const notificationDropdown = document.getElementById('notificationDropdown');
                
                if (!notificationBadge || !notificationDropdown) return;
                
                // Fetch real-time data from backend
                const token = localStorage.getItem('token');
                if (!token) return;

                const response = await fetch('/api/user/logs', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) return;

                const data = await response.json();
                if (!data.success) return;

                const userData = data.user;
                const activities = data.activities || [];
                
                // Use backend notification count
                const notificationCount = userData.notificationCount || 1;
                notificationBadge.textContent = notificationCount;
                
                // Get password expiry data
                const passwordData = await fetchRealPasswordData();
                const daysRemaining = passwordData.daysUntilExpiry;
                
                // Update the password expiry notification in the dropdown
                const passwordNotification = notificationDropdown.querySelector('.notification-item:nth-child(2)');
                if (passwordNotification) {
                    const titleElement = passwordNotification.querySelector('div:first-child');
                    const messageElement = passwordNotification.querySelector('div:nth-child(2)');
                    const timeElement = passwordNotification.querySelector('div:nth-child(3)');
                    
                    if (daysRemaining <= 0) {
                        titleElement.textContent = 'üö® Password Expired!';
                        messageElement.innerHTML = '<strong style="color: #dc2626;">Your password has expired and must be changed immediately</strong>';
                        passwordNotification.style.borderLeft = '4px solid #dc2626';
                        passwordNotification.style.background = '#fef2f2';
                        timeElement.textContent = 'Immediate Action Required';
                    } else if (daysRemaining <= 7) {
                        titleElement.textContent = '‚ö†Ô∏è Password Expiring Soon';
                        messageElement.innerHTML = `<strong style="color: #d97706;">Your password expires in ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''}</strong>`;
                        passwordNotification.style.borderLeft = '4px solid #d97706';
                        passwordNotification.style.background = '#fef3c7';
                        timeElement.textContent = 'Change password soon';
                    } else if (daysRemaining <= 14) {
                        titleElement.textContent = 'üí° Password Change Reminder';
                        messageElement.innerHTML = `Your password expires in ${daysRemaining} days`;
                        passwordNotification.style.borderLeft = '4px solid #3b82f6';
                        passwordNotification.style.background = '#eff6ff';
                        timeElement.textContent = 'Reminder';
                    } else {
                        titleElement.textContent = '‚úÖ Password Status Good';
                        messageElement.innerHTML = `Your password expires in ${daysRemaining} days`;
                        passwordNotification.style.borderLeft = '4px solid #10b981';
                        passwordNotification.style.background = '#f0fdf4';
                        timeElement.textContent = 'All good';
                    }
                }
                
                // Add new device notification if there are recent new devices
                const recentDeviceLogins = activities.filter(a => 
                    a.type === 'login' && 
                    (new Date() - new Date(a.timestamp)) < (24 * 60 * 60 * 1000) // Last 24 hours
                );
                
                if (recentDeviceLogins.length > 1) {
                    const deviceNotification = notificationDropdown.querySelector('.notification-item:nth-child(3)');
                    if (deviceNotification) {
                        const titleElement = deviceNotification.querySelector('div:first-child');
                        const messageElement = deviceNotification.querySelector('div:nth-child(2)');
                        const timeElement = deviceNotification.querySelector('div:nth-child(3)');
                        
                        titleElement.textContent = 'üì± New Device Activity';
                        messageElement.innerHTML = `Recent logins detected from ${recentDeviceLogins.length} device${recentDeviceLogins.length !== 1 ? 's' : ''}`;
                        timeElement.textContent = 'Last 24 hours';
                        deviceNotification.style.borderLeft = '4px solid #6366f1';
                        deviceNotification.style.background = '#f0f9ff';
                    }
                }
                
                // Add security alert notification if there are failed attempts
                if (userData.failedAttempts > 0) {
                    const securityNotification = notificationDropdown.querySelector('.notification-item:nth-child(4)');
                    if (securityNotification) {
                        const titleElement = securityNotification.querySelector('div:first-child');
                        const messageElement = securityNotification.querySelector('div:nth-child(2)');
                        const timeElement = securityNotification.querySelector('div:nth-child(3)');
                        
                        titleElement.textContent = 'üîí Security Alert';
                        messageElement.innerHTML = `${userData.failedAttempts} failed login attempt${userData.failedAttempts !== 1 ? 's' : ''}`;
                        timeElement.textContent = 'Monitor your account';
                        securityNotification.style.borderLeft = '4px solid #ef4444';
                        securityNotification.style.background = '#fef2f2';
                    }
                }
                
                console.log('üîî Notifications updated successfully:', {
                    totalNotifications: notificationCount,
                    passwordDaysRemaining: daysRemaining,
                    recentDeviceLogins: recentDeviceLogins.length,
                    failedAttempts: userData.failedAttempts
                });
                
            } catch (error) {
                console.error('Error updating notifications:', error);
                // Fallback to default notification count
                const notificationBadge = document.getElementById('notificationBadge');
                if (notificationBadge) {
                    notificationBadge.textContent = '1';
                }
            }
        }
        
        // Legacy function for backward compatibility
        function updatePasswordExpiryNotifications(daysRemaining) {
            updateComprehensiveNotifications();
        }
        
        // Function to manually record password change (called when password is actually changed)
        async function recordPasswordChange() {
            console.log('üîê Password change detected - refreshing data from backend...');
            
            try {
                // Refresh the display with real backend data
                const passwordExpiryInfo = await calculateRealPasswordExpiry();
                document.getElementById('passwordExpiryDate').textContent = passwordExpiryInfo.formattedExpiryDate;
                document.getElementById('passwordDaysLeft').textContent = passwordExpiryInfo.daysUntilExpiry;
                
                // Update notifications
                updatePasswordExpiryNotifications(passwordExpiryInfo.daysRemaining);
                
                // Show success message
                Swal.fire({
                    title: '‚úÖ Password Updated!',
                    html: `
                        <div style="text-align: left;">
                            <p style="margin-bottom: 15px;"><strong>Password successfully changed!</strong></p>
                            <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                                <div><strong>New change date:</strong> ${passwordExpiryInfo.formattedLastChange}</div>
                                <div><strong>New expiry date:</strong> ${passwordExpiryInfo.formattedExpiryDate}</div>
                                <div><strong>Days remaining:</strong> ${passwordExpiryInfo.daysRemaining} days</div>
                                <div><strong>Policy:</strong> 30-day password rotation</div>
                                <div><strong>Data source:</strong> Real-time backend sync</div>
                            </div>
                        </div>
                    `,
                    icon: 'success',
                    timer: 4000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error refreshing password data:', error);
                Swal.fire({
                    title: '‚ö†Ô∏è Data Sync Warning',
                    text: 'Password updated successfully, but dashboard data may not be current. Please refresh the page.',
                    icon: 'warning',
                    timer: 3000
                });
            }
        }
        
        // Real-time password expiry checker (runs every minute)
        async function startPasswordExpiryChecker() {
            console.log('üîê Starting real-time password expiry checker with backend sync...');
            
            // Initial check
            try {
                const passwordInfo = await calculateRealPasswordExpiry();
                updatePasswordExpiryNotifications(passwordInfo.daysRemaining);
                
                // Update UI elements immediately
                document.getElementById('passwordExpiryDate').textContent = passwordInfo.formattedExpiryDate;
                document.getElementById('passwordDaysLeft').textContent = passwordInfo.daysUntilExpiry;
                
                console.log('üîê Initial password check completed:', {
                    daysRemaining: passwordInfo.daysRemaining,
                    expiryDate: passwordInfo.formattedExpiryDate,
                    dataSource: 'Backend'
                });
            } catch (error) {
                console.error('Error in initial password check:', error);
            }
            
            // Set up real-time updates every 2 minutes (to avoid too many API calls)
            setInterval(async () => {
                try {
                    const updatedPasswordInfo = await calculateRealPasswordExpiry();
                    
                    // Update UI elements
                    document.getElementById('passwordExpiryDate').textContent = updatedPasswordInfo.formattedExpiryDate;
                    document.getElementById('passwordDaysLeft').textContent = updatedPasswordInfo.daysUntilExpiry;
                    
                    // Update comprehensive notifications
                    updateComprehensiveNotifications();
                    
                    // Log changes for debugging
                    console.log(`üîê Password expiry check: ${updatedPasswordInfo.daysRemaining} days remaining (Backend sync)`);
                    
                    // Show critical alerts
                    if (updatedPasswordInfo.isExpired && !sessionStorage.getItem('expiredAlertShown')) {
                        sessionStorage.setItem('expiredAlertShown', 'true');
                        Swal.fire({
                            title: 'üö® Password Expired!',
                            text: 'Your password has expired. You must change it now to continue using the system.',
                            icon: 'error',
                            confirmButtonText: 'Change Password',
                            allowOutsideClick: false
                        }).then(() => {
                            window.location.href = '/change-password.html';
                        });
                    } else if (updatedPasswordInfo.daysRemaining === 1 && !sessionStorage.getItem('oneDayAlertShown')) {
                        sessionStorage.setItem('oneDayAlertShown', 'true');
                        Swal.fire({
                            title: '‚ö†Ô∏è Password Expires Tomorrow!',
                            text: 'Your password will expire in 1 day. Please change it soon to avoid account issues.',
                            icon: 'warning',
                            confirmButtonText: 'Change Password',
                            showCancelButton: true,
                            cancelButtonText: 'Remind Later'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/change-password.html';
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error in password expiry check:', error);
                    // Continue with next check even if this one failed
                }
                
            }, 120000); // Check every 2 minutes for real-time updates
        }
        
        // Simulate password changes for testing (can be called from console)
        function simulatePasswordChange(daysAgo = 0) {
            const changeDate = new Date();
            changeDate.setDate(changeDate.getDate() - daysAgo);
            
            localStorage.setItem('lastPasswordChange', changeDate.toISOString());
            localStorage.removeItem('passwordMetadata');
            
            // Clear alert flags
            localStorage.removeItem('expiredAlertShown');
            localStorage.removeItem('oneDayAlertShown');
            
            console.log(`üîê Simulated password change: ${daysAgo} days ago (${changeDate.toLocaleString()})`);
            
            // Refresh display immediately
            const passwordExpiryInfo = calculateRealPasswordExpiry();
            document.getElementById('passwordExpiryDate').textContent = passwordExpiryInfo.formattedExpiryDate;
            document.getElementById('passwordDaysLeft').textContent = passwordExpiryInfo.daysUntilExpiry;
            updatePasswordExpiryNotifications(passwordExpiryInfo.daysRemaining);
            
            Swal.fire({
                title: 'üîÑ Password Date Simulated',
                html: `
                    <div style="text-align: left;">
                        <p><strong>Simulated password change:</strong> ${daysAgo} days ago</p>
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 10px;">
                            <div><strong>Expires:</strong> ${passwordExpiryInfo.formattedExpiryDate}</div>
                            <div><strong>Days left:</strong> ${passwordExpiryInfo.daysRemaining}</div>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            <strong>Test scenarios:</strong><br>
                            ‚Ä¢ simulatePasswordChange(0) - Just changed<br>
                            ‚Ä¢ simulatePasswordChange(25) - Expires in 5 days<br>
                            ‚Ä¢ simulatePasswordChange(29) - Expires tomorrow<br>
                            ‚Ä¢ simulatePasswordChange(31) - Already expired
                        </div>
                    </div>
                `,
                icon: 'info',
                timer: 5000
            });
        }
        
        // Expose functions globally for external calls
        window.recordPasswordChange = recordPasswordChange;
        window.simulatePasswordChange = simulatePasswordChange;
        window.calculateRealPasswordExpiry = calculateRealPasswordExpiry;
        window.refreshPasswordData = async function() {
            console.log('üîÑ Manually refreshing password data from backend...');
            try {
                const passwordInfo = await calculateRealPasswordExpiry();
                document.getElementById('passwordExpiryDate').textContent = passwordInfo.formattedExpiryDate;
                document.getElementById('passwordDaysLeft').textContent = passwordInfo.daysUntilExpiry;
                updatePasswordExpiryNotifications(passwordInfo.daysRemaining);
                
                Swal.fire({
                    title: '‚úÖ Data Refreshed!',
                    html: `
                        <div style="text-align: left;">
                            <p><strong>Password data synced from backend:</strong></p>
                            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 10px;">
                                <div><strong>Created:</strong> ${passwordInfo.formattedLastChange}</div>
                                <div><strong>Expires:</strong> ${passwordInfo.formattedExpiryDate}</div>
                                <div><strong>Days remaining:</strong> ${passwordInfo.daysRemaining}</div>
                                <div><strong>Status:</strong> ${passwordInfo.isExpired ? 'üî¥ EXPIRED' : passwordInfo.isUrgent ? 'üü° URGENT' : passwordInfo.isWarning ? 'üü† WARNING' : 'üü¢ SAFE'}</div>
                            </div>
                        </div>
                    `,
                    icon: 'success',
                    timer: 3000
                });
                return passwordInfo;
            } catch (error) {
                console.error('Error refreshing password data:', error);
                Swal.fire('Error', 'Failed to refresh password data from backend', 'error');
                throw error;
            }
        };

        // Debug function to test activity logs endpoint
        window.debugActivityLogs = async function() {
            console.log('üîç [DEBUG] Testing activity logs endpoint...');
            try {
                const token = localStorage.getItem('token');
                console.log('üîç [DEBUG] Token present:', !!token, token ? token.substring(0, 20) + '...' : 'None');
                
                const response = await fetch('/api/user/logs', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üîç [DEBUG] Response status:', response.status);
                console.log('üîç [DEBUG] Response headers:', Object.fromEntries(response.headers.entries()));
                
                const responseText = await response.text();
                console.log('üîç [DEBUG] Raw response:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('üîç [DEBUG] Parsed response:', data);
                } catch (parseError) {
                    console.error('üîç [DEBUG] Failed to parse JSON:', parseError);
                    return { error: 'Invalid JSON response', raw: responseText };
                }
                
                return data;
            } catch (error) {
                console.error('üîç [DEBUG] Activity logs test failed:', error);
                return { error: error.message };
            }
        };

        // Debug function to test API connectivity
        window.debugApiTest = async function() {
            console.log('üîç [DEBUG] Testing API connectivity...');
            try {
                return await testApiConnectivity();
            } catch (error) {
                console.error('üîç [DEBUG] API test failed:', error);
                return { error: error.message };
            }
        };
        
        // Debug function to show current password status
        window.showPasswordStatus = function() {
            const info = calculateRealPasswordExpiry();
            const metadata = JSON.parse(localStorage.getItem('passwordMetadata') || '{}');
            
            console.log('üîê Current Password Status:');
            console.log('‚îÄ'.repeat(40));
            console.log(`üìÖ Last Changed: ${info.formattedLastChange}`);
            console.log(`üìÖ Expires On: ${info.formattedExpiryDate}`);
            console.log(`‚è∞ Days Remaining: ${info.daysRemaining}`);
            console.log(`üö® Status: ${info.isExpired ? 'EXPIRED' : info.isUrgent ? 'URGENT' : info.isWarning ? 'WARNING' : 'SAFE'}`);
            console.log(`üìä Policy: ${metadata.policyDays || 30} days`);
            console.log('‚îÄ'.repeat(40));
            console.log('Available commands:');
            console.log('‚Ä¢ showPasswordStatus() - Show this status');
            console.log('‚Ä¢ simulatePasswordChange(daysAgo) - Test different scenarios');
            console.log('‚Ä¢ recordPasswordChange() - Record actual password change');
            
            return info;
        };
        
        // Show initial password status in console for debugging
        setTimeout(() => {
            console.log('üîê Real-time Password Expiry System Initialized');
            console.log('Type showPasswordStatus() in console to see current status');
            console.log('Type simulatePasswordChange(X) to test scenarios');
        }, 1000);

        // Debug function to show current password status with real-time verification
        window.showPasswordStatus = function() {
            const info = calculateRealPasswordExpiry();
            const metadata = JSON.parse(localStorage.getItem('passwordMetadata') || '{}');
            const realCurrentDate = new Date();
            
            console.log('üîê Real-Time Password Status Verification:');
            console.log('‚ïê'.repeat(50));
            console.log(`üìÖ TODAY'S DATE: ${realCurrentDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })}`);
            console.log(`üïê CURRENT TIME: ${realCurrentDate.toLocaleTimeString()}`);
            console.log('‚îÄ'.repeat(50));
            console.log(`üìÖ Password Last Changed: ${info.formattedLastChange}`);
            console.log(`üìÖ Password Expires On: ${info.formattedExpiryDate}`);
            console.log(`‚è∞ Days Remaining: ${info.daysRemaining} days`);
            console.log(`üö® Status: ${info.isExpired ? 'üî¥ EXPIRED' : info.isUrgent ? 'üü° URGENT' : info.isWarning ? 'üü† WARNING' : 'üü¢ SAFE'}`);
            console.log(`üìä Policy: ${metadata.policyDays || 30} days from password change`);
            console.log('‚îÄ'.repeat(50));
            console.log('üîß Available Testing Commands:');
            console.log('‚Ä¢ showPasswordStatus() - Show this real-time status');
            console.log('‚Ä¢ simulatePasswordChange(3) - Test: Password changed 3 days ago');
            console.log('‚Ä¢ simulatePasswordChange(25) - Test: Expires in 5 days (urgent)');
            console.log('‚Ä¢ simulatePasswordChange(29) - Test: Expires tomorrow');
            console.log('‚Ä¢ simulatePasswordChange(31) - Test: Already expired');
            console.log('‚Ä¢ recordPasswordChange() - Record actual password change NOW');
            console.log('‚Ä¢ verifyRealTimeCalculation() - Verify calculation with current date');
            console.log('‚ïê'.repeat(50));
            
            return {
                ...info,
                realCurrentDate: realCurrentDate.toISOString(),
                realCurrentDateFormatted: realCurrentDate.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })
            };
        };
        
        // Verify real-time calculation function
        window.verifyRealTimeCalculation = function() {
            const now = new Date();
            console.log('üïê Real-Time Calculation Verification:');
            console.log('‚ïê'.repeat(50));
            console.log(`üìÖ Current Date/Time: ${now.toString()}`);
            console.log(`üìÖ Formatted Date: ${now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })}`);
            
            // Test calculation for 3 days ago scenario
            const testChangeDate = new Date();
            testChangeDate.setDate(testChangeDate.getDate() - 3);
            
            const testExpiryDate = new Date(testChangeDate);
            testExpiryDate.setDate(testExpiryDate.getDate() + 30);
            
            const testDaysRemaining = Math.ceil((testExpiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
            
            console.log('‚îÄ'.repeat(50));
            console.log('üß™ TEST SCENARIO: Password changed 3 days ago');
            console.log(`üìÖ Change Date: ${testChangeDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })}`);
            console.log(`üìÖ Expiry Date: ${testExpiryDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })}`);
            console.log(`‚è∞ Days Remaining: ${testDaysRemaining} days`);
            console.log('‚ïê'.repeat(50));
            
            return {
                currentDate: now.toISOString(),
                testChangeDate: testChangeDate.toISOString(),
                testExpiryDate: testExpiryDate.toISOString(),
                testDaysRemaining
            };
        };
        
        // Enhanced simulate function with real-time verification
        window.simulatePasswordChangeWithVerification = function(daysAgo = 0) {
            const realNow = new Date();
            const changeDate = new Date();
            changeDate.setDate(changeDate.getDate() - daysAgo);
            
            console.log('üîÑ Password Change Simulation with Real-Time Verification:');
            console.log('‚ïê'.repeat(60));
            console.log(`üìÖ TODAY (Real Current Date): ${realNow.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })}`);
            console.log(`üìÖ Simulated Change Date: ${changeDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })} (${daysAgo} days ago)`);
            
            // Calculate expiry
            const expiryDate = new Date(changeDate);
            expiryDate.setDate(expiryDate.getDate() + 30);
            
            const daysRemaining = Math.ceil((expiryDate.getTime() - realNow.getTime()) / (1000 * 60 * 60 * 24));
            
            console.log(`üìÖ Calculated Expiry Date: ${expiryDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })}`);
            console.log(`‚è∞ Days Remaining: ${daysRemaining} days`);
            console.log('‚ïê'.repeat(60));
            
            // Apply the simulation
            localStorage.setItem('lastPasswordChange', changeDate.toISOString());
            localStorage.removeItem('passwordMetadata');
            localStorage.removeItem('expiredAlertShown');
            localStorage.removeItem('oneDayAlertShown');
            
            // Refresh display
            const passwordExpiryInfo = calculateRealPasswordExpiry();
            document.getElementById('passwordExpiryDate').textContent = passwordExpiryInfo.formattedExpiryDate;
            document.getElementById('passwordDaysLeft').textContent = passwordExpiryInfo.daysUntilExpiry;
            updatePasswordExpiryNotifications(passwordExpiryInfo.daysRemaining);
            
            Swal.fire({
                title: 'üîÑ Real-Time Password Simulation',
                html: `
                    <div style="text-align: left;">
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #0ea5e9;">
                            <div style="font-weight: 600; margin-bottom: 8px;">üìÖ Current Date Verification:</div>
                            <div><strong>Today:</strong> ${realNow.toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}</div>
                            <div><strong>Time:</strong> ${realNow.toLocaleTimeString()}</div>
                        </div>
                        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                            <div style="font-weight: 600; margin-bottom: 8px;">üîÑ Simulation Applied:</div>
                            <div><strong>Password Changed:</strong> ${daysAgo} days ago</div>
                            <div><strong>Change Date:</strong> ${passwordExpiryInfo.formattedLastChange}</div>
                        </div>
                        <div style="background: ${daysRemaining <= 7 ? '#fef2f2' : daysRemaining <= 14 ? '#fef3c7' : '#f0fdf4'}; padding: 15px; border-radius: 8px; border-left: 4px solid ${daysRemaining <= 7 ? '#ef4444' : daysRemaining <= 14 ? '#f59e0b' : '#10b981'};">
                            <div style="font-weight: 600; margin-bottom: 8px;">üìä Real-Time Results:</div>
                            <div><strong>Expires On:</strong> ${passwordExpiryInfo.formattedExpiryDate}</div>
                            <div><strong>Days Remaining:</strong> ${daysRemaining} days</div>
                            <div><strong>Status:</strong> ${daysRemaining <= 0 ? 'üî¥ EXPIRED' : daysRemaining <= 7 ? 'üü° URGENT' : daysRemaining <= 14 ? 'üü† WARNING' : 'üü¢ SAFE'}</div>
                        </div>
                    </div>
                `,
                icon: daysRemaining <= 7 ? 'warning' : 'info',
                width: 600,
                timer: 8000
            });
            
            return {
                realCurrentDate: realNow.toISOString(),
                simulatedChangeDate: changeDate.toISOString(),
                calculatedExpiryDate: expiryDate.toISOString(),
                daysRemaining,
                verification: 'Using real current date for all calculations'
            };
        };

        function changePassword() {
            Swal.fire({
                title: 'üîê Change Password',
                html: `
                    <div style="text-align: left; max-width: 500px; margin: 0 auto;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Current Password:</label>
                            <div style="position: relative;">
                                <input type="password" id="currentPasswordPopup" class="swal2-input" placeholder="Enter current password" style="margin: 0; padding-right: 40px;" autocomplete="current-password">
                                <button type="button" id="toggleCurrentPassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer; padding: 5px;">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">New Password:</label>
                            <div style="position: relative;">
                                <input type="password" id="newPasswordPopup" class="swal2-input" placeholder="Enter new password" style="margin: 0; padding-right: 80px;" autocomplete="new-password">
                                <button type="button" id="generatePasswordPopup" style="position: absolute; right: 40px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #007bff; cursor: pointer; padding: 5px;" title="Generate Strong Password">
                                    <i class="fas fa-key"></i>
                                </button>
                                <button type="button" id="toggleNewPassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer; padding: 5px;">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            
                            <!-- Password Strength Meter -->
                            <div style="margin-top: 8px;">
                                <div style="width: 100%; height: 4px; background: #e9ecef; border-radius: 2px; overflow: hidden; margin-bottom: 5px;">
                                    <div id="strengthMeterPopup" style="height: 100%; background: #dc3545; border-radius: 2px; transition: all 0.3s ease; width: 0%;"></div>
                                </div>
                                <span id="strengthTextPopup" style="font-size: 12px; font-weight: 600; color: #dc3545;">Enter password</span>
                            </div>
                            
                            <!-- Password Requirements -->
                            <div id="requirementsListPopup" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 12px; margin-top: 10px; font-size: 12px; display: none;">
                                <p style="margin: 0 0 8px 0; font-weight: 600; color: #495057;">Password Requirements:</p>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li id="reqLengthPopup" style="display: flex; align-items: center; gap: 6px; padding: 2px 0; color: #dc3545; transition: color 0.3s ease;"><i class="fas fa-times" style="font-size: 10px; width: 12px;"></i> At least 12 characters</li>
                                    <li id="reqUppercasePopup" style="display: flex; align-items: center; gap: 6px; padding: 2px 0; color: #dc3545; transition: color 0.3s ease;"><i class="fas fa-times" style="font-size: 10px; width: 12px;"></i> At least 2 uppercase letters</li>
                                    <li id="reqLowercasePopup" style="display: flex; align-items: center; gap: 6px; padding: 2px 0; color: #dc3545; transition: color 0.3s ease;"><i class="fas fa-times" style="font-size: 10px; width: 12px;"></i> At least 2 lowercase letters</li>
                                    <li id="reqNumberPopup" style="display: flex; align-items: center; gap: 6px; padding: 2px 0; color: #dc3545; transition: color 0.3s ease;"><i class="fas fa-times" style="font-size: 10px; width: 12px;"></i> At least 2 numbers</li>
                                    <li id="reqSpecialPopup" style="display: flex; align-items: center; gap: 6px; padding: 2px 0; color: #dc3545; transition: color 0.3s ease;"><i class="fas fa-times" style="font-size: 10px; width: 12px;"></i> At least 2 special characters</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Confirm New Password:</label>
                            <div style="position: relative;">
                                <input type="password" id="confirmPasswordPopup" class="swal2-input" placeholder="Confirm new password" style="margin: 0; padding-right: 40px;" autocomplete="new-password">
                                <button type="button" id="toggleConfirmPassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer; padding: 5px;">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `,
                width: 600,
                showCancelButton: true,
                confirmButtonText: 'Change Password',
                cancelButtonText: 'Cancel',
                preConfirm: () => {
                    const currentPassword = document.getElementById('currentPasswordPopup').value;
                    const newPassword = document.getElementById('newPasswordPopup').value;
                    const confirmPassword = document.getElementById('confirmPasswordPopup').value;
                    
                    if (!currentPassword) {
                        Swal.showValidationMessage('Current password is required');
                        return false;
                    }
                    
                    if (!newPassword) {
                        Swal.showValidationMessage('New password is required');
                        return false;
                    }
                    
                    if (newPassword !== confirmPassword) {
                        Swal.showValidationMessage('New passwords do not match');
                        return false;
                    }
                    
                    // Validate password requirements
                    const validation = validatePasswordRequirements(newPassword);
                    if (!validation.valid) {
                        Swal.showValidationMessage('Password does not meet requirements: ' + validation.errors.join(', '));
                        return false;
                    }
                    
                    return { currentPassword, newPassword, confirmPassword };
                },
                didOpen: () => {
                    // Initialize password functionality after popup opens
                    initializePasswordPopup();
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    handlePasswordChange(result.value);
                }
            });
        }

        // Initialize password popup functionality
        function initializePasswordPopup() {
            const currentPasswordInput = document.getElementById('currentPasswordPopup');
            const newPasswordInput = document.getElementById('newPasswordPopup');
            const confirmPasswordInput = document.getElementById('confirmPasswordPopup');
            const toggleCurrentBtn = document.getElementById('toggleCurrentPassword');
            const toggleNewBtn = document.getElementById('toggleNewPassword');
            const toggleConfirmBtn = document.getElementById('toggleConfirmPassword');
            const generateBtn = document.getElementById('generatePasswordPopup');
            
            // Password visibility toggles
            toggleCurrentBtn.addEventListener('click', () => togglePasswordVisibility(currentPasswordInput, toggleCurrentBtn));
            toggleNewBtn.addEventListener('click', () => togglePasswordVisibility(newPasswordInput, toggleNewBtn));
            toggleConfirmBtn.addEventListener('click', () => togglePasswordVisibility(confirmPasswordInput, toggleConfirmBtn));
            
            // Generate password
            generateBtn.addEventListener('click', () => {
                const generatedPassword = generateStrongPassword();
                newPasswordInput.value = generatedPassword;
                confirmPasswordInput.value = generatedPassword;
                updatePasswordStrength(generatedPassword);
            });
            
            // Password strength checking
            newPasswordInput.addEventListener('input', (e) => {
                updatePasswordStrength(e.target.value);
            });
        }
        
        // Toggle password visibility
        function togglePasswordVisibility(input, button) {
            const icon = button.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }
        
        // Generate strong password
        function generateStrongPassword() {
            const length = 16;
            const charset = {
                uppercase: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                lowercase: 'abcdefghijklmnopqrstuvwxyz',
                numbers: '0123456789',
                special: '!@#$%^&*()_+-=[]{}|;:,.<>?'
            };

            let password = '';
            
            // Ensure at least 2 of each character type
            password += charset.uppercase[Math.floor(Math.random() * charset.uppercase.length)];
            password += charset.uppercase[Math.floor(Math.random() * charset.uppercase.length)];
            password += charset.lowercase[Math.floor(Math.random() * charset.lowercase.length)];
            password += charset.lowercase[Math.floor(Math.random() * charset.lowercase.length)];
            password += charset.numbers[Math.floor(Math.random() * charset.numbers.length)];
            password += charset.numbers[Math.floor(Math.random() * charset.numbers.length)];
            password += charset.special[Math.floor(Math.random() * charset.special.length)];
            password += charset.special[Math.floor(Math.random() * charset.special.length)];

            // Fill the rest with random characters
            const allChars = charset.uppercase + charset.lowercase + charset.numbers + charset.special;
            for (let i = password.length; i < length; i++) {
                password += allChars[Math.floor(Math.random() * allChars.length)];
            }

            // Shuffle the password
            return password.split('').sort(() => Math.random() - 0.5).join('');
        }
        
        // Update password strength meter
        function updatePasswordStrength(password) {
            const strengthMeter = document.getElementById('strengthMeterPopup');
            const strengthText = document.getElementById('strengthTextPopup');
            const requirementsList = document.getElementById('requirementsListPopup');
            
            if (!password) {
                strengthMeter.style.width = '0%';
                strengthText.textContent = 'Enter password';
                strengthText.style.color = '#dc3545';
                requirementsList.style.display = 'none';
                return;
            }
            
            requirementsList.style.display = 'block';
            
            const validation = validatePasswordRequirements(password);
            const score = validation.score;
            
            // Update strength meter
            strengthMeter.style.width = `${score}%`;
            
            if (score < 25) {
                strengthMeter.style.background = '#dc3545';
                strengthText.textContent = 'Very Weak';
                strengthText.style.color = '#dc3545';
            } else if (score < 50) {
                strengthMeter.style.background = '#fd7e14';
                strengthText.textContent = 'Weak';
                strengthText.style.color = '#fd7e14';
            } else if (score < 75) {
                strengthMeter.style.background = '#ffc107';
                strengthText.textContent = 'Fair';
                strengthText.style.color = '#ffc107';
            } else if (score < 100) {
                strengthMeter.style.background = '#20c997';
                strengthText.textContent = 'Good';
                strengthText.style.color = '#20c997';
            } else {
                strengthMeter.style.background = '#28a745';
                strengthText.textContent = 'Excellent';
                strengthText.style.color = '#28a745';
            }
            
            // Update requirements checklist
            updateRequirementItem('reqLengthPopup', password.length >= 12);
            updateRequirementItem('reqUppercasePopup', (password.match(/[A-Z]/g) || []).length >= 2);
            updateRequirementItem('reqLowercasePopup', (password.match(/[a-z]/g) || []).length >= 2);
            updateRequirementItem('reqNumberPopup', (password.match(/[0-9]/g) || []).length >= 2);
            updateRequirementItem('reqSpecialPopup', (password.match(/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/g) || []).length >= 2);
        }
        
        // Update requirement item status
        function updateRequirementItem(elementId, isMet) {
            const element = document.getElementById(elementId);
            if (element) {
                const icon = element.querySelector('i');
                if (isMet) {
                    element.style.color = '#28a745';
                    icon.className = 'fas fa-check';
                } else {
                    element.style.color = '#dc3545';
                    icon.className = 'fas fa-times';
                }
            }
        }
        
        // Validate password requirements (same as original system)
        function validatePasswordRequirements(password) {
            const errors = [];
            let score = 0;
            
            if (password.length >= 12) {
                score += 20;
            } else {
                errors.push('At least 12 characters');
            }
            
            if ((password.match(/[A-Z]/g) || []).length >= 2) {
                score += 20;
            } else {
                errors.push('At least 2 uppercase letters');
            }
            
            if ((password.match(/[a-z]/g) || []).length >= 2) {
                score += 20;
            } else {
                errors.push('At least 2 lowercase letters');
            }
            
            if ((password.match(/[0-9]/g) || []).length >= 2) {
                score += 20;
            } else {
                errors.push('At least 2 numbers');
            }
            
            if ((password.match(/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/g) || []).length >= 2) {
                score += 20;
            } else {
                errors.push('At least 2 special characters');
            }
            
            return {
                valid: errors.length === 0,
                errors: errors,
                score: score
            };
        }
        
        // Handle logout button click
        function handleLogoutClick(e) {
            e.preventDefault();
            
            Swal.fire({
                title: 'üö™ Confirm Logout',
                html: `
                    <div style="text-align: center;">
                        <div style="font-size: 48px; color: #f59e0b; margin-bottom: 20px;">
                            <i class="fas fa-sign-out-alt"></i>
                        </div>
                        <p style="font-size: 16px; margin-bottom: 15px; color: #374151;">
                            Are you sure you want to logout?
                        </p>
                        <p style="color: #6b7280; margin-bottom: 20px;">
                            This will end your current session and clear all session data.
                        </p>
                        <div style="background: #eff6ff; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <small style="color: #1e40af;">
                                üîê <strong>Security:</strong> All session data, cache, and cookies will be cleared.
                            </small>
                        </div>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Logout',
                cancelButtonText: 'Stay Logged In',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#10b981',
                focusCancel: true
            }).then((result) => {
                if (result.isConfirmed) {
                    // Call the logout function directly
                    performLogout();
                }
            });
        }

        // Global logout function accessible from anywhere
        function performLogout() {
            console.log('üö™ Manual logout initiated...');
            
            Swal.fire({
                title: 'Logging Out...',
                html: 'Clearing session data and logging you out securely across all tabs...',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    Swal.showLoading();
                    setTimeout(() => {
                        performLogoutCleanup('manual_logout');
                    }, 500);
                }
            });
        }

        // Global logout cleanup function
        async function performLogoutCleanup(reason = 'session_expired') {
            try {
                console.log(`üßπ Starting logout cleanup - Reason: ${reason}`);
                
                // 1. Clear all localStorage data
                try {
                    const localStorageKeys = Object.keys(localStorage);
                    localStorageKeys.forEach(key => {
                        localStorage.removeItem(key);
                    });
                    console.log('‚úÖ localStorage cleared');
                } catch (e) {
                    console.warn('‚ö†Ô∏è localStorage cleanup error:', e);
                }
                
                // 2. Clear all sessionStorage data
                try {
                    const sessionStorageKeys = Object.keys(sessionStorage);
                    sessionStorageKeys.forEach(key => {
                        sessionStorage.removeItem(key);
                    });
                    console.log('‚úÖ sessionStorage cleared');
                } catch (e) {
                    console.warn('‚ö†Ô∏è sessionStorage cleanup error:', e);
                }
                
                // 3. Clear all cookies
                try {
                    document.cookie.split(";").forEach(cookie => {
                        const eqPos = cookie.indexOf("=");
                        const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
                        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=.${window.location.hostname};secure;samesite=strict`;
                        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;secure;samesite=strict`;
                        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
                    });
                    console.log('‚úÖ Cookies cleared');
                } catch (e) {
                    console.warn('‚ö†Ô∏è Cookie cleanup error:', e);
                }
                
                // 4. Call server-side logout endpoint
                try {
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache',
                            'Clear-Site-Data': '"cache", "cookies", "storage", "executionContexts"'
                        }
                    });
                    console.log('‚úÖ Server-side logout completed');
                } catch (e) {
                    console.warn('‚ö†Ô∏è Server-side logout error:', e);
                }
                
                console.log('üéØ Logout cleanup completed successfully');
                
                // Force redirect with cache busting
                const timestamp = Date.now();
                window.location.replace(`/login.html?t=${timestamp}&reason=${reason}`);
                
            } catch (error) {
                console.error('‚ùå Critical logout error:', error);
                // Force redirect even if cleanup fails
                window.location.replace('/login.html?error=logout_failed');
            }
        }
        
        // Handle password change submission
        async function handlePasswordChange(passwordData) {
            try {
                // Show loading
                Swal.fire({
                    title: 'Changing Password...',
                    text: 'Please wait while we update your password.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // Get CSRF token
                const csrfResponse = await fetch('/api/csrf-token', {
                    credentials: 'include'
                });
                
                if (!csrfResponse.ok) {
                    throw new Error('Failed to get CSRF token');
                }
                
                const csrfData = await csrfResponse.json();
                const csrfToken = csrfData.csrfToken;
                
                // Get auth token
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Authentication required');
                }
                
                // Make password change request
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({
                        currentPassword: passwordData.currentPassword,
                        newPassword: passwordData.newPassword,
                        _csrf: csrfToken
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Update password change tracking
                    recordPasswordChange();
                    
                    Swal.fire({
                        title: 'Password Changed Successfully!',
                        text: 'Your password has been updated. Please log in with your new password.',
                        icon: 'success',
                        confirmButtonText: 'Continue'
                    }).then(() => {
                        // Force logout and redirect to login
                        localStorage.clear();
                        sessionStorage.clear();
                        window.location.href = '/login.html';
                    });
                } else {
                    throw new Error(result.message || 'Failed to change password');
                }
                
            } catch (error) {
                console.error('Password change error:', error);
                Swal.fire({
                    title: 'Password Change Failed',
                    text: error.message || 'An error occurred while changing your password. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'Try Again'
                });
            }
        }

        // Enhanced device management (similar to Google security)
        async function showDeviceManagement() {
            try {
                const deviceData = await loadDeviceInformation();
                const devices = deviceData.devices || [];
                const summary = deviceData.summary || {};
                
                let devicesHtml = '';
                
                if (devices.length === 0) {
                    devicesHtml = '<p style="text-align: center; color: #6b7280; padding: 20px;">No devices found.</p>';
                } else {
                    devices.forEach((device) => {
                        const isActive = device.isActive;
                        const isCurrent = device.id === 'current_session';
                        const statusColor = isActive ? '#10b981' : '#6b7280';
                        const statusText = isCurrent ? 'THIS DEVICE' : isActive ? 'ACTIVE' : 'INACTIVE';
                        
                        devicesHtml += `
                            <div style="padding: 18px; border: 1px solid ${isActive ? '#10b981' : '#d1d5db'}; border-radius: 12px; margin-bottom: 15px; background: ${isActive ? '#f0fdf4' : '#ffffff'};">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                    <div style="display: flex; align-items: center;">
                                        <i class="fas fa-${getDeviceIcon(device.deviceType)}" style="color: ${statusColor}; margin-right: 15px; font-size: 28px;"></i>
                                        <div>
                                            <div style="font-weight: 600; color: #1f2937; font-size: 18px; margin-bottom: 2px;">${device.deviceName}</div>
                                            <div style="color: #6b7280; font-size: 14px;">${device.browser} on ${device.os}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                                        <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px;">${statusText}</span>
                                        ${!isCurrent && !isActive ? 
                                            `<button onclick="revokeDeviceAccess('${device.id}', '${device.deviceName}')" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; cursor: pointer; font-weight: 500; transition: all 0.2s;">Sign Out</button>` : 
                                            ''
                                        }
                                    </div>
                                </div>
                                <div style="background: #f8fafc; padding: 12px; border-radius: 8px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 13px;">
                                    <div><span style="color: #6b7280;">IP Address:</span><br><strong>${device.ipAddress}</strong></div>
                                    <div><span style="color: #6b7280;">Location:</span><br><strong>${device.location}</strong></div>
                                    <div><span style="color: #6b7280;">First Seen:</span><br><strong>${new Date(device.firstSeen).toLocaleDateString()}</strong></div>
                                    <div><span style="color: #6b7280;">Last Active:</span><br><strong>${formatTimeAgo(device.lastSeen)}</strong></div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                Swal.fire({
                    title: 'üîê Device & Session Management',
                    html: `
                        <div style="text-align: left; max-height: 600px; overflow-y: auto;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center;">
                                    <div>
                                        <div style="font-size: 28px; font-weight: 700; margin-bottom: 4px;">${summary.totalDevices}</div>
                                        <div style="font-size: 12px; opacity: 0.9;">Total Devices</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 28px; font-weight: 700; margin-bottom: 4px; color: #22c55e;">${summary.activeDevices}</div>
                                        <div style="font-size: 12px; opacity: 0.9;">Active Now</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 28px; font-weight: 700; margin-bottom: 4px; color: #f87171;">${summary.inactiveDevices}</div>
                                        <div style="font-size: 12px; opacity: 0.9;">Inactive</div>
                                    </div>
                                </div>
                            </div>
                            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                                <div style="font-size: 14px; color: #92400e;">
                                    <strong>üí° Security Tip:</strong> Review your devices regularly and revoke access for any device you don't recognize or no longer use.
                                </div>
                            </div>
                            ${devicesHtml}
                        </div>
                    `,
                    width: 900,
                    confirmButtonText: 'Close',
                    showCancelButton: true,
                    cancelButtonText: 'Refresh',
                    customClass: {
                        htmlContainer: 'custom-swal-container'
                    }
                }).then((result) => {
                    if (result.dismiss === Swal.DismissReason.cancel) {
                        showDeviceManagement(); // Refresh
                    }
                });

            } catch (error) {
                console.error('Error in device management:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to load device information. Please try again.',
                    icon: 'error'
                });
            }
        }

        // Helper function to format time ago
        function formatTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffMs = now - time;
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMinutes < 5) return 'Just now';
            if (diffMinutes < 60) return `${diffMinutes} minutes ago`;
            if (diffHours < 24) return `${diffHours} hours ago`;
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return time.toLocaleDateString();
        }

        // Make functions globally accessible
        window.revokeDeviceAccess = revokeDeviceAccess;

        // Debug functions for testing
        window.testActivityLogs = async function() {
            console.log('üß™ Testing Activity Logs API...');
            try {
                await loadRecentActivity();
                console.log('‚úÖ Activity logs test completed');
            } catch (error) {
                console.error('‚ùå Activity logs test failed:', error);
            }
        };

        window.testDeviceManagement = async function() {
            console.log('üß™ Testing Device Management API...');
            try {
                const deviceData = await loadDeviceInformation();
                console.log('‚úÖ Device management test completed:', deviceData);
                return deviceData;
            } catch (error) {
                console.error('‚ùå Device management test failed:', error);
            }
        };

        window.showCleanActivityFeed = async function() {
            console.log('üìã Showing Clean Activity Feed...');
            await viewAllActivity();
        };

        console.log(`
üîß Debug Functions Available:
‚Ä¢ testActivityLogs() - Test activity logs API
‚Ä¢ testDeviceManagement() - Test device management
‚Ä¢ showCleanActivityFeed() - Show complete activity list
‚Ä¢ viewAllSessions() - Google-like device management
‚Ä¢ showDeviceManagement() - Enhanced device security
        `);
    </script>
</body>
</html>